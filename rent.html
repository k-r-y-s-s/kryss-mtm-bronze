<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rent - My Tenant Manager</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞ Menu</button>
    
    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>üè† My Tenant Manager</h2>
            <p class="sidebar-subtitle">Rent Management</p>
        </div>
        
        <nav class="sidebar-nav">
            <a href="dashboard.html" class="nav-link">
                <span class="nav-icon">üìä</span>
                <span>Dashboard</span>
            </a>
            <a href="tenants.html" class="nav-link">
                <span class="nav-icon">üë•</span>
                <span>Tenants</span>
            </a>
            <a href="utilities.html" class="nav-link">
                <span class="nav-icon">‚ö°</span>
                <span>Utilities</span>
            </a>
            <a href="rent.html" class="nav-link active">
                <span class="nav-icon">üí∞</span>
                <span>Rent</span>
            </a>
            <a href="payments.html" class="nav-link">
                <span class="nav-icon">üí≥</span>
                <span>Payments</span>
            </a>
            <a href="ledger.html" class="nav-link">
                <span class="nav-icon">üìí</span>
                <span>Ledger</span>
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <button onclick="logout()" class="btn btn-outline" style="width: 100%;">
                üö™ Logout
            </button>
        </div>
    </div>
    
    <!-- MAIN CONTENT -->
    <div class="main-content">
        <div class="page-header">
            <div>
                <h1>üí∞ Rent Management</h1>
                <p class="small-text">Manual rent generation with duplicate prevention</p>
            </div>
            <div>
                <button onclick="showGenerateRentModal()" class="btn btn-primary">
                    Generate Rent Charges
                </button>
                <button onclick="showBulkGenerateModal()" class="btn btn-secondary" style="margin-left: 0.5rem;">
                    Bulk Generate
                </button>
            </div>
        </div>
        
        <!-- Filter Options -->
        <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
            <select id="filterTenant" onchange="filterRentCharges()" class="form-group" style="flex: 1; min-width: 200px;">
                <option value="">All Tenants</option>
            </select>
            <select id="filterStatus" onchange="filterRentCharges()" class="form-group" style="flex: 1; min-width: 200px;">
                <option value="">All Status</option>
                <option value="paid">Paid</option>
                <option value="unpaid">Unpaid</option>
            </select>
            <input type="month" id="filterMonth" onchange="filterRentCharges()" class="form-group" style="flex: 1; min-width: 200px;">
        </div>
        
        <!-- Rent Charges Table -->
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Month</th>
                        <th>Tenant</th>
                        <th>Amount</th>
                        <th>Due Date</th>
                        <th>Status</th>
                        <th>Paid Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="rentTableBody">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem;">
                            Loading rent charges...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Summary Stats -->
        <div class="stats-grid" style="margin-top: 2rem;">
            <div class="stat-card">
                <h3>Total Due</h3>
                <div class="stat-number" id="totalDue">‚Ç±0.00</div>
                <span class="stat-trend">Unpaid rent</span>
            </div>
            <div class="stat-card">
                <h3>Total Paid</h3>
                <div class="stat-number" id="totalPaid">‚Ç±0.00</div>
                <span class="stat-trend">This month</span>
            </div>
            <div class="stat-card">
                <h3>Overdue</h3>
                <div class="stat-number" id="totalOverdue">‚Ç±0.00</div>
                <span class="stat-trend">Past due date</span>
            </div>
        </div>
    </div>
    
    <!-- ============================================
         MODAL 1: GENERATE RENT CHARGES (Manual Trigger)
         ============================================ -->
    <div class="modal-overlay hidden" id="generateRentModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Generate Rent Charges</h3>
                <button class="close-modal" onclick="closeGenerateRentModal()">√ó</button>
            </div>
            
            <div class="modal-body">
                <form id="generateRentForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="generateMonth">For Month *</label>
                            <input type="month" id="generateMonth" required>
                        </div>
                        <div class="form-group">
                            <label for="generateTenant">Select Tenant *</label>
                            <select id="generateTenant" required>
                                <option value="">Select Tenant</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="padding: 1rem; background: #f3f4f6; border-radius: 0.375rem; margin-bottom: 1.5rem;">
                        <p><strong>Note:</strong> This will generate rent charge for the selected tenant based on:</p>
                        <ul style="margin: 0.5rem 0 0.5rem 1.5rem;">
                            <li>Tenant's monthly rent amount</li>
                            <li>Tenant's rent due day</li>
                            <li>Prevents duplicate charges for same month</li>
                        </ul>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeGenerateRentModal()">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Generate Rent Charge
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- ============================================
         MODAL 2: BULK GENERATE FOR ALL TENANTS
         ============================================ -->
    <div class="modal-overlay hidden" id="bulkGenerateModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Bulk Generate Rent Charges</h3>
                <button class="close-modal" onclick="closeBulkGenerateModal()">√ó</button>
            </div>
            
            <div class="modal-body">
                <form id="bulkGenerateForm">
                    <div class="form-group">
                        <label for="bulkMonth">Generate for Month *</label>
                        <input type="month" id="bulkMonth" required>
                    </div>
                    
                    <div style="padding: 1rem; background: #fef3c7; border-radius: 0.375rem; margin-bottom: 1.5rem; border-left: 4px solid #f59e0b;">
                        <p><strong>Warning:</strong> This will generate rent charges for <strong>ALL ACTIVE TENANTS</strong></p>
                        <p class="small-text" style="margin-top: 0.5rem;">
                            Charges will only be created for tenants who don't already have rent for this month.
                        </p>
                    </div>
                    
                    <div id="bulkPreview" style="display: none; margin-bottom: 1.5rem;">
                        <h4>Preview of charges to be generated:</h4>
                        <div style="max-height: 200px; overflow-y: auto; margin-top: 1rem;">
                            <table style="width: 100%; font-size: 0.875rem;">
                                <thead>
                                    <tr>
                                        <th>Tenant</th>
                                        <th>Amount</th>
                                        <th>Due Date</th>
                                    </tr>
                                </thead>
                                <tbody id="bulkPreviewBody">
                                    <!-- Will be populated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeBulkGenerateModal()">
                            Cancel
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="previewBulkGenerate()">
                            Preview
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Generate All
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- ============================================
         MODAL 3: MARK AS PAID
         ============================================ -->
    <div class="modal-overlay hidden" id="markPaidModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Mark Rent as Paid</h3>
                <button class="close-modal" onclick="closeMarkPaidModal()">√ó</button>
            </div>
            
            <div class="modal-body">
                <form id="markPaidForm">
                    <input type="hidden" id="rentChargeId">
                    
                    <div class="form-group">
                        <label for="paidDate">Payment Date *</label>
                        <input type="date" id="paidDate" required value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    
                    <div class="form-group">
                        <label for="paymentMethod">Payment Method</label>
                        <select id="paymentMethod">
                            <option value="cash">Cash</option>
                            <option value="gcash">GCash</option>
                            <option value="bank_transfer">Bank Transfer</option>
                            <option value="check">Check</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="paymentNotes">Notes (Optional)</label>
                        <textarea id="paymentNotes" rows="2" placeholder="Reference number, etc."></textarea>
                    </div>
                    
                    <div style="padding: 1rem; background: #f3f4f6; border-radius: 0.375rem; margin-bottom: 1.5rem;">
                        <p><strong>Note:</strong> This will also create a payment record in the ledger.</p>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeMarkPaidModal()">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Mark as Paid
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://hnjlrjtiomdqcqznkuxh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhuamxyanRpb21kcWNxem5rdXhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4NDQ5MTUsImV4cCI6MjA4NTQyMDkxNX0.iW9E91LYLNSkpjiITNcXa7Zj1rpcw8euriHkgfQ19dQ';
        const supabase = supabaseClient.createClient(supabaseUrl, supabaseKey);
        
        let currentUser = null;
        let allRentCharges = [];
        let allTenants = [];
        let rentToMarkPaidId = null;
        
        // Check authentication
        supabase.auth.getSession().then(async ({ data: { session } }) => {
            if (!session) {
                window.location.href = 'login.html';
            } else {
                currentUser = session.user;
                await loadTenants();
                await loadRentCharges();
                updateSummary();
                
                // Set default month filter to current month
                const now = new Date();
                const currentYearMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
                document.getElementById('filterMonth').value = currentYearMonth;
                document.getElementById('generateMonth').value = currentYearMonth;
                document.getElementById('bulkMonth').value = currentYearMonth;
            }
        });
        
        // Load tenants for dropdowns
        async function loadTenants() {
            try {
                const { data: tenants, error } = await supabase
                    .from('tenants')
                    .select('id, name, monthly_rent, rent_due_day')
                    .eq('user_id', currentUser.id)
                    .eq('status', 'active')
                    .order('name');
                
                if (error) throw error;
                
                allTenants = tenants || [];
                
                // Update tenant dropdowns
                const filterSelect = document.getElementById('filterTenant');
                const generateSelect = document.getElementById('generateTenant');
                
                filterSelect.innerHTML = '<option value="">All Tenants</option>';
                generateSelect.innerHTML = '<option value="">Select Tenant</option>';
                
                tenants.forEach(tenant => {
                    filterSelect.innerHTML += `<option value="${tenant.id}">${tenant.name}</option>`;
                    generateSelect.innerHTML += `<option value="${tenant.id}">${tenant.name} (‚Ç±${parseFloat(tenant.monthly_rent).toLocaleString('en-PH')} due ${tenant.rent_due_day}th)</option>`;
                });
                
            } catch (error) {
                console.error('Error loading tenants:', error);
            }
        }
        
        // Load rent charges
        async function loadRentCharges() {
            try {
                const { data: rentCharges, error } = await supabase
                    .from('rent_charges')
                    .select(`
                        *,
                        tenants(name)
                    `)
                    .eq('user_id', currentUser.id)
                    .order('month', { ascending: false });
                
                if (error) throw error;
                
                allRentCharges = rentCharges || [];
                filterRentCharges();
                
            } catch (error) {
                console.error('Error loading rent charges:', error);
            }
        }
        
        // Filter rent charges
        function filterRentCharges() {
            const tenantId = document.getElementById('filterTenant').value;
            const status = document.getElementById('filterStatus').value;
            const month = document.getElementById('filterMonth').value;
            
            let filtered = allRentCharges;
            
            if (tenantId) {
                filtered = filtered.filter(r => r.tenant_id === tenantId);
            }
            
            if (status === 'paid') {
                filtered = filtered.filter(r => r.paid === true);
            } else if (status === 'unpaid') {
                filtered = filtered.filter(r => r.paid === false);
            }
            
            if (month) {
                filtered = filtered.filter(r => {
                    const rentMonth = r.month.slice(0, 7); // YYYY-MM
                    return rentMonth === month;
                });
            }
            
            updateRentTable(filtered);
            updateSummary(filtered);
        }
        
        // Update rent table
        function updateRentTable(rentCharges) {
            const tbody = document.getElementById('rentTableBody');
            
            if (rentCharges.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem;">
                            No rent charges found.
                        </td>
                    </tr>
                `;
                return;
            }
            
            const today = new Date();
            let html = '';
            
            rentCharges.forEach(charge => {
                const month = new Date(charge.month);
                const dueDate = new Date(charge.due_date);
                const isOverdue = !charge.paid && dueDate < today;
                
                // Status display
                let statusClass, statusText;
                if (charge.paid) {
                    statusClass = 'status-active';
                    statusText = 'Paid';
                } else if (isOverdue) {
                    statusClass = 'status-left';
                    statusText = 'Overdue';
                } else {
                    statusClass = 'status-moved-out';
                    statusText = 'Unpaid';
                }
                
                html += `
                    <tr>
                        <td>${month.toLocaleDateString('en-PH', { month: 'long', year: 'numeric' })}</td>
                        <td><strong>${charge.tenants?.name || 'Unknown'}</strong></td>
                        <td class="currency">‚Ç±${parseFloat(charge.amount).toLocaleString('en-PH', { minimumFractionDigits: 2 })}</td>
                        <td>${dueDate.toLocaleDateString('en-PH')}</td>
                        <td>
                            <span class="status-pill ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                        <td>${charge.paid_at ? new Date(charge.paid_at).toLocaleDateString('en-PH') : '-'}</td>
                        <td>
                            ${!charge.paid ? `
                                <button class="action-btn edit" onclick="showMarkPaidModal('${charge.id}')">
                                    Mark Paid
                                </button>
                            ` : ''}
                            <button class="action-btn delete" onclick="deleteRentCharge('${charge.id}')">
                                Delete
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Update summary stats
        function updateSummary(rentCharges = allRentCharges) {
            const today = new Date();
            let totalDue = 0;
            let totalPaid = 0;
            let totalOverdue = 0;
            
            rentCharges.forEach(charge => {
                const dueDate = new Date(charge.due_date);
                const amount = parseFloat(charge.amount);
                
                if (charge.paid) {
                    totalPaid += amount;
                } else {
                    totalDue += amount;
                    if (dueDate < today) {
                        totalOverdue += amount;
                    }
                }
            });
            
            document.getElementById('totalDue').textContent = 
                '‚Ç±' + totalDue.toLocaleString('en-PH', { minimumFractionDigits: 2 });
            document.getElementById('totalPaid').textContent = 
                '‚Ç±' + totalPaid.toLocaleString('en-PH', { minimumFractionDigits: 2 });
            document.getElementById('totalOverdue').textContent = 
                '‚Ç±' + totalOverdue.toLocaleString('en-PH', { minimumFractionDigits: 2 });
        }
        
        // ============================================
        // GENERATE RENT CHARGES (Manual Trigger)
        // ============================================
        function showGenerateRentModal() {
            document.getElementById('generateRentForm').reset();
            
            // Set default month to current month
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('generateMonth').value = `${year}-${month}`;
            
            document.getElementById('generateRentModal').classList.remove('hidden');
        }
        
        // Generate rent for single tenant
        document.getElementById('generateRentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const month = document.getElementById('generateMonth').value;
            const tenantId = document.getElementById('generateTenant').value;
            
            if (!month || !tenantId) {
                alert('Please select both month and tenant.');
                return;
            }
            
            // Find tenant
            const tenant = allTenants.find(t => t.id === tenantId);
            if (!tenant) {
                alert('Selected tenant not found.');
                return;
            }
            
            // Check for duplicate rent (Prevents duplicate as specified)
            try {
                const { data: existingCharge, error: checkError } = await supabase
                    .from('rent_charges')
                    .select('id')
                    .eq('tenant_id', tenantId)
                    .eq('month', month + '-01')
                    .single();
                
                if (existingCharge) {
                    alert('Rent charge already exists for this tenant and month.');
                    return;
                }
                
            } catch (error) {
                // No existing charge found, continue
            }
            
            // Calculate due date
            const dueDate = new Date(month + '-01');
            dueDate.setDate(tenant.rent_due_day);
            
            // Create rent charge
            try {
                const { error } = await supabase
                    .from('rent_charges')
                    .insert([{
                        user_id: currentUser.id,
                        tenant_id: tenantId,
                        amount: tenant.monthly_rent,
                        due_date: dueDate.toISOString().split('T')[0],
                        month: month + '-01',
                        paid: false
                    }]);
                
                if (error) throw error;
                
                alert('‚úì Rent charge generated successfully!');
                closeGenerateRentModal();
                await loadRentCharges();
                
            } catch (error) {
                console.error('Error generating rent:', error);
                alert('‚úó Failed to generate rent charge: ' + error.message);
            }
        });
        
        // ============================================
        // BULK GENERATE FOR ALL ACTIVE TENANTS
        // ============================================
        function showBulkGenerateModal() {
            document.getElementById('bulkGenerateForm').reset();
            
            // Set default month to current month
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('bulkMonth').value = `${year}-${month}`;
            
            document.getElementById('bulkPreview').style.display = 'none';
            document.getElementById('generateRentModal').classList.add('hidden');
            document.getElementById('bulkGenerateModal').classList.remove('hidden');
        }
        
        // Preview bulk generation
        async function previewBulkGenerate() {
            const month = document.getElementById('bulkMonth').value;
            
            if (!month) {
                alert('Please select a month.');
                return;
            }
            
            // Check which tenants don't have rent for this month
            const tenantsWithoutRent = [];
            
            for (const tenant of allTenants) {
                try {
                    const { data: existingCharge, error } = await supabase
                        .from('rent_charges')
                        .select('id')
                        .eq('tenant_id', tenant.id)
                        .eq('month', month + '-01')
                        .single();
                    
                    // If error (no existing charge), add to list
                    if (error && error.code === 'PGRST116') {
                        tenantsWithoutRent.push(tenant);
                    }
                } catch (error) {
                    console.error('Error checking for existing rent:', error);
                }
            }
            
            // Update preview
            const previewBody = document.getElementById('bulkPreviewBody');
            previewBody.innerHTML = '';
            
            if (tenantsWithoutRent.length === 0) {
                previewBody.innerHTML = `
                    <tr>
                        <td colspan="3" style="text-align: center; padding: 1rem;">
                            All active tenants already have rent charges for ${month}.
                        </td>
                    </tr>
                `;
            } else {
                tenantsWithoutRent.forEach(tenant => {
                    const dueDate = new Date(month + '-01');
                    dueDate.setDate(tenant.rent_due_day);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${tenant.name}</td>
                        <td>‚Ç±${parseFloat(tenant.monthly_rent).toLocaleString('en-PH')}</td>
                        <td>${dueDate.toLocaleDateString('en-PH')}</td>
                    `;
                    previewBody.appendChild(row);
                });
            }
            
            document.getElementById('bulkPreview').style.display = 'block';
        }
        
        // Bulk generate rent charges
        document.getElementById('bulkGenerateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const month = document.getElementById('bulkMonth').value;
            
            if (!month) {
                alert('Please select a month.');
                return;
            }
            
            if (!confirm(`Generate rent charges for ALL active tenants for ${month}?`)) {
                return;
            }
            
            // Get tenants without rent for this month
            const tenantsToCharge = [];
            
            for (const tenant of allTenants) {
                try {
                    const { data: existingCharge, error } = await supabase
                        .from('rent_charges')
                        .select('id')
                        .eq('tenant_id', tenant.id)
                        .eq('month', month + '-01')
                        .single();
                    
                    // If error (no existing charge), add to list
                    if (error && error.code === 'PGRST116') {
                        tenantsToCharge.push(tenant);
                    }
                } catch (error) {
                    console.error('Error checking for existing rent:', error);
                }
            }
            
            if (tenantsToCharge.length === 0) {
                alert('All active tenants already have rent charges for this month.');
                return;
            }
            
            // Create rent charges for each tenant
            const rentCharges = tenantsToCharge.map(tenant => {
                const dueDate = new Date(month + '-01');
                dueDate.setDate(tenant.rent_due_day);
                
                return {
                    user_id: currentUser.id,
                    tenant_id: tenant.id,
                    amount: tenant.monthly_rent,
                    due_date: dueDate.toISOString().split('T')[0],
                    month: month + '-01',
                    paid: false
                };
            });
            
            try {
                const { error } = await supabase
                    .from('rent_charges')
                    .insert(rentCharges);
                
                if (error) throw error;
                
                alert(`‚úì Generated ${rentCharges.length} rent charges successfully!`);
                closeBulkGenerateModal();
                await loadRentCharges();
                
            } catch (error) {
                console.error('Error bulk generating rent:', error);
                alert('‚úó Failed to generate rent charges: ' + error.message);
            }
        });
        
        // ============================================
        // MARK RENT AS PAID
        // ============================================
        function showMarkPaidModal(rentChargeId) {
            rentToMarkPaidId = rentChargeId;
            document.getElementById('markPaidForm').reset();
            document.getElementById('paidDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('markPaidModal').classList.remove('hidden');
        }
        
        // Mark rent as paid
        document.getElementById('markPaidForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const paidDate = document.getElementById('paidDate').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const paymentNotes = document.getElementById('paymentNotes').value;
            
            if (!rentToMarkPaidId) {
                alert('No rent charge selected.');
                return;
            }
            
            // Find the rent charge to get tenant and amount
            const rentCharge = allRentCharges.find(r => r.id === rentToMarkPaidId);
            if (!rentCharge) {
                alert('Rent charge not found.');
                return;
            }
            
            try {
                // 1. Update rent charge as paid
                const { error: rentError } = await supabase
                    .from('rent_charges')
                    .update({
                        paid: true,
                        paid_at: paidDate + 'T00:00:00Z'
                    })
                    .eq('id', rentToMarkPaidId)
                    .eq('user_id', currentUser.id);
                
                if (rentError) throw rentError;
                
                // 2. Create payment record
                const { error: paymentError } = await supabase
                    .from('payments')
                    .insert([{
                        user_id: currentUser.id,
                        tenant_id: rentCharge.tenant_id,
                        amount: rentCharge.amount,
                        payment_date: paidDate,
                        payment_method: paymentMethod,
                        for_rent: true,
                        notes: paymentNotes || `Rent payment for ${new Date(rentCharge.month).toLocaleDateString('en-PH', { month: 'long', year: 'numeric' })}`
                    }]);
                
                if (paymentError) throw paymentError;
                
                alert('‚úì Rent marked as paid successfully!');
                closeMarkPaidModal();
                await loadRentCharges();
                
            } catch (error) {
                console.error('Error marking rent as paid:', error);
                alert('‚úó Failed to mark rent as paid: ' + error.message);
            }
        });
        
        // ============================================
        // DELETE RENT CHARGE
        // ============================================
        async function deleteRentCharge(rentChargeId) {
            if (!confirm('Are you sure you want to delete this rent charge?\n\nThis will also remove the corresponding ledger entry.')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('rent_charges')
                    .delete()
                    .eq('id', rentChargeId)
                    .eq('user_id', currentUser.id);
                
                if (error) throw error;
                
                alert('‚úì Rent charge deleted successfully!');
                await loadRentCharges();
                
            } catch (error) {
                console.error('Error deleting rent charge:', error);
                alert('‚úó Failed to delete rent charge');
            }
        }
        
        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        function closeGenerateRentModal() {
            document.getElementById('generateRentModal').classList.add('hidden');
        }
        
        function closeBulkGenerateModal() {
            document.getElementById('bulkGenerateModal').classList.add('hidden');
        }
        
        function closeMarkPaidModal() {
            document.getElementById('markPaidModal').classList.add('hidden');
            rentToMarkPaidId = null;
        }
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }
        
        async function logout() {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        }
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const mobileBtn = document.querySelector('.mobile-menu-btn');
            
            if (window.innerWidth <= 1024 && 
                !sidebar.contains(event.target) && 
                event.target !== mobileBtn) {
                sidebar.classList.remove('active');
            }
        });
    </script>
</body>
</html>
