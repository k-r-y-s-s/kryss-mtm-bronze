<!DOCTYPE html>
<html>
<head>
    <title>Dashboard - My Tenant Manager</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞ Menu</button>
    
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>üè† MTM</h2>
        </div>
        
        <nav class="sidebar-nav">
            <a href="dashboard.html" class="nav-item active">üìä Dashboard</a>
            <a href="tenants.html" class="nav-item">üë• Tenants</a>
            <a href="utilities.html" class="nav-item">‚ö° Utilities</a>
            <a href="rent.html" class="nav-item">üí∞ Rent</a>
            <a href="payments.html" class="nav-item">üí≥ Payments</a>
            <a href="ledger.html" class="nav-item">üìí Ledger</a>
        </nav>
        
        <div class="sidebar-footer">
            <button onclick="logout()" class="btn btn-primary" style="width: 100%;">
                üö™ Logout
            </button>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <div class="page-header">
            <h1>Dashboard</h1>
            <div id="userEmail">Loading...</div>
        </div>
        
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Monthly Rent Total</h3>
                <div class="stat-number" id="monthlyRent">‚Ç±0.00</div>
            </div>
            
            <div class="stat-card">
                <h3>Monthly Utilities</h3>
                <div class="stat-number" id="monthlyUtilities">‚Ç±0.00</div>
            </div>
            
            <div class="stat-card">
                <h3>Payments Received</h3>
                <div class="stat-number" id="paymentsReceived">‚Ç±0.00</div>
            </div>
            
            <div class="stat-card">
                <h3>Active Tenants</h3>
                <div class="stat-number" id="activeTenants">0</div>
            </div>
        </div>
        
        <!-- Needs Attention -->
        <div class="table-container" style="margin-bottom: 30px;">
            <h2 style="padding: 20px; margin: 0;">‚ö†Ô∏è Needs Attention</h2>
            <table class="data-table">
                <tbody id="attentionList">
                    <tr>
                        <td colspan="3" style="text-align: center; padding: 40px;">
                            No issues found. All tenants are up to date.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Recent Activity -->
        <div class="table-container">
            <h2 style="padding: 20px; margin: 0;">üìã Recent Activity</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Tenant</th>
                        <th>Type</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody id="activityList">
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 40px;">
                            Loading recent activity...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://hnjlrjtiomdqcqznkuxh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhuamxyanRpb21kcWNxem5rdXhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4NDQ5MTUsImV4cCI6MjA4NTQyMDkxNX0.iW9E91LYLNSkpjiITNcXa7Zj1rpcw8euriHkgfQ19dQ';
        const supabase = supabaseClient.createClient(supabaseUrl, supabaseKey);
        
        let currentUser = null;
        
        // Check authentication
        supabase.auth.getSession().then(({ data: { session } }) => {
            if (!session) {
                window.location.href = 'login.html';
            } else {
                currentUser = session.user;
                document.getElementById('userEmail').textContent = session.user.email;
                loadDashboardData();
            }
        });
        
        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Get active tenants
                const { data: tenants, error: tenantsError } = await supabase
                    .from('tenants')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('status', 'active');
                
                if (tenantsError) throw tenantsError;
                
                // Calculate monthly rent
                let monthlyRent = 0;
                if (tenants) {
                    tenants.forEach(tenant => {
                        monthlyRent += parseFloat(tenant.monthly_rent);
                    });
                }
                
                // Update dashboard
                document.getElementById('monthlyRent').textContent = 
                    '‚Ç±' + monthlyRent.toLocaleString('en-PH');
                document.getElementById('activeTenants').textContent = tenants ? tenants.length : 0;
                
                // Sample data (you'll replace with real data later)
                document.getElementById('monthlyUtilities').textContent = '‚Ç±2,500.00';
                document.getElementById('paymentsReceived').textContent = '‚Ç±15,000.00';
                
                // Sample recent activity
                const activityList = document.getElementById('activityList');
                activityList.innerHTML = `
                    <tr>
                        <td>Today</td>
                        <td>Juan Dela Cruz</td>
                        <td>Rent Payment</td>
                        <td>‚Ç±5,000.00</td>
                    </tr>
                    <tr>
                        <td>Yesterday</td>
                        <td>Maria Santos</td>
                        <td>Electric Bill</td>
                        <td>‚Ç±1,200.00</td>
                    </tr>
                    <tr>
                        <td>Dec 1, 2024</td>
                        <td>Pedro Reyes</td>
                        <td>Water Bill</td>
                        <td>‚Ç±800.00</td>
                    </tr>
                `;
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }
        
        // Toggle sidebar for mobile
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }
        
        // Logout function
        async function logout() {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        }
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const mobileBtn = document.querySelector('.mobile-menu-btn');
            
            if (window.innerWidth <= 768 && 
                !sidebar.contains(event.target) && 
                event.target !== mobileBtn) {
                sidebar.classList.remove('active');
            }
        });
    </script>
</body>
</html>
