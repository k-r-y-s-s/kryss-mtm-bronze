<!DOCTYPE html>
<html>
<head>
    <title>Tenants - My Tenant Manager</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞ Menu</button>
    
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>üè† MTM</h2>
        </div>
        
        <nav class="sidebar-nav">
            <a href="dashboard.html" class="nav-item">üìä Dashboard</a>
            <a href="tenants.html" class="nav-item active">üë• Tenants</a>
            <a href="utilities.html" class="nav-item">‚ö° Utilities</a>
            <a href="rent.html" class="nav-item">üí∞ Rent</a>
            <a href="payments.html" class="nav-item">üí≥ Payments</a>
            <a href="ledger.html" class="nav-item">üìí Ledger</a>
        </nav>
        
        <div class="sidebar-footer">
            <button onclick="logout()" class="btn btn-primary" style="width: 100%;">
                üö™ Logout
            </button>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <div class="page-header">
            <h1>üë• Tenants</h1>
            <button onclick="showAddModal()" class="btn btn-primary">
                Ôºã Add Tenant
            </button>
        </div>
        
        <!-- Tenants Table -->
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Monthly Rent</th>
                        <th>Due Day</th>
                        <th>Utilities</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tenantsTable">
                    <!-- Data will load here -->
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px;">
                            Loading tenants...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Add Tenant Modal -->
    <div class="modal" id="addModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add New Tenant</h2>
                <button class="close-modal" onclick="closeModal()">√ó</button>
            </div>
            
            <form id="tenantForm">
                <input type="hidden" id="tenantId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="name">Full Name *</label>
                        <input type="text" id="name" required>
                    </div>
                    <div class="form-group">
                        <label for="rent">Monthly Rent (‚Ç±) *</label>
                        <input type="number" id="rent" required min="0" step="0.01">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="dueDay">Rent Due Day (1-31) *</label>
                        <input type="number" id="dueDay" required min="1" max="31">
                    </div>
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select id="status">
                            <option value="active">Active</option>
                            <option value="moved_out">Moved Out</option>
                            <option value="left_without_notice">Left Without Notice</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Utilities Assigned</label>
                    <div style="display: flex; gap: 20px; margin-top: 10px;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="hasElectric"> Electric
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="hasWater"> Water
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="hasWifi"> Wi-Fi
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="notes">Notes</label>
                    <textarea id="notes" rows="3"></textarea>
                </div>
                
                <div style="margin-top: 30px; text-align: right;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Save Tenant
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Consent Modal -->
    <div class="modal" id="consentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ö†Ô∏è Data Consent Required</h2>
                <button class="close-modal" onclick="closeConsentModal()">√ó</button>
            </div>
            
            <div style="padding: 20px;">
                <p><strong>Important:</strong> By adding this tenant, you confirm that:</p>
                <ul style="margin: 15px 0 15px 20px;">
                    <li>You have the legal right to collect and store this personal information</li>
                    <li>You will comply with data protection regulations</li>
                    <li>This information will be used only for rental management purposes</li>
                </ul>
                <p style="color: #92400e; font-weight: bold;">
                    Data Privacy Act of 2012 (Philippines) applies
                </p>
                
                <div style="margin-top: 30px; text-align: right;">
                    <button type="button" class="btn btn-secondary" onclick="closeConsentModal()">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-primary" onclick="confirmConsent()">
                        I Understand & Continue
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://hnjlrjtiomdqcqznkuxh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhuamxyanRpb21kcWNxem5rdXhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4NDQ5MTUsImV4cCI6MjA4NTQyMDkxNX0.iW9E91LYLNSkpjiITNcXa7Zj1rpcw8euriHkgfQ19dQ';
        const supabase = supabaseClient.createClient(supabaseUrl, supabaseKey);
        
        let currentUser = null;
        let currentTenantId = null;
        let pendingTenantData = null;
        
        // Check authentication
        supabase.auth.getSession().then(({ data: { session } }) => {
            if (!session) {
                window.location.href = 'login.html';
            } else {
                currentUser = session.user;
                loadTenants();
            }
        });
        
        // Load tenants
        async function loadTenants() {
            try {
                const { data: tenants, error } = await supabase
                    .from('tenants')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                updateTenantsTable(tenants || []);
                
            } catch (error) {
                console.error('Error loading tenants:', error);
                document.getElementById('tenantsTable').innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px;">
                            Error loading tenants
                        </td>
                    </tr>
                `;
            }
        }
        
        // Update table with tenant data
        function updateTenantsTable(tenants) {
            const tbody = document.getElementById('tenantsTable');
            
            if (tenants.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px;">
                            No tenants yet. Click "Add Tenant" to get started.
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            tenants.forEach(tenant => {
                // Format utilities
                let utilities = '';
                if (tenant.has_electric) utilities += '‚ö° ';
                if (tenant.has_water) utilities += 'üíß ';
                if (tenant.has_wifi) utilities += 'üì∂ ';
                if (!utilities) utilities = 'None';
                
                // Status badge
                let statusClass = '';
                let statusText = '';
                if (tenant.status === 'active') {
                    statusClass = 'status-active';
                    statusText = 'Active';
                } else if (tenant.status === 'moved_out') {
                    statusClass = 'status-moved';
                    statusText = 'Moved Out';
                } else {
                    statusClass = 'status-left';
                    statusText = 'Left';
                }
                
                html += `
                    <tr>
                        <td><strong>${tenant.name}</strong></td>
                        <td>‚Ç±${parseFloat(tenant.monthly_rent).toFixed(2)}</td>
                        <td>${tenant.rent_due_day}th</td>
                        <td>${utilities}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <button onclick="editTenant('${tenant.id}')" 
                                    style="background: none; border: 1px solid #3a82f7; color: #3a82f7; padding: 5px 10px; border-radius: 4px; margin-right: 5px; cursor: pointer;">
                                Edit
                            </button>
                            <button onclick="deleteTenant('${tenant.id}')" 
                                    style="background: none; border: 1px solid #dc2626; color: #dc2626; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                                Delete
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Show add modal
        function showAddModal() {
            currentTenantId = null;
            document.getElementById('modalTitle').textContent = 'Add New Tenant';
            document.getElementById('tenantForm').reset();
            document.getElementById('tenantId').value = '';
            document.getElementById('addModal').style.display = 'flex';
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('addModal').style.display = 'none';
        }
        
        // Close consent modal
        function closeConsentModal() {
            document.getElementById('consentModal').style.display = 'none';
        }
        
        // Edit tenant
        async function editTenant(tenantId) {
            try {
                const { data: tenant, error } = await supabase
                    .from('tenants')
                    .select('*')
                    .eq('id', tenantId)
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (error) throw error;
                
                currentTenantId = tenantId;
                document.getElementById('modalTitle').textContent = 'Edit Tenant';
                
                // Fill form
                document.getElementById('tenantId').value = tenant.id;
                document.getElementById('name').value = tenant.name;
                document.getElementById('rent').value = tenant.monthly_rent;
                document.getElementById('dueDay').value = tenant.rent_due_day;
                document.getElementById('status').value = tenant.status;
                document.getElementById('hasElectric').checked = tenant.has_electric;
                document.getElementById('hasWater').checked = tenant.has_water;
                document.getElementById('hasWifi').checked = tenant.has_wifi;
                document.getElementById('notes').value = tenant.notes || '';
                
                document.getElementById('addModal').style.display = 'flex';
                
            } catch (error) {
                console.error('Error loading tenant:', error);
                alert('Error loading tenant data');
            }
        }
        
        // Save tenant (form submission)
        document.getElementById('tenantForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const tenantData = {
                user_id: currentUser.id,
                name: document.getElementById('name').value,
                monthly_rent: parseFloat(document.getElementById('rent').value),
                rent_due_day: parseInt(document.getElementById('dueDay').value),
                status: document.getElementById('status').value,
                has_electric: document.getElementById('hasElectric').checked,
                has_water: document.getElementById('hasWater').checked,
                has_wifi: document.getElementById('hasWifi').checked,
                notes: document.getElementById('notes').value
            };
            
            if (currentTenantId) {
                // Update existing tenant
                await saveTenant(tenantData, currentTenantId);
            } else {
                // Show consent modal for new tenants
                pendingTenantData = tenantData;
                document.getElementById('consentModal').style.display = 'flex';
            }
        });
        
        // Confirm consent and save
        async function confirmConsent() {
            if (pendingTenantData) {
                await saveTenant(pendingTenantData);
                document.getElementById('consentModal').style.display = 'none';
                pendingTenantData = null;
            }
        }
        
        // Save tenant to database
        async function saveTenant(tenantData, tenantId = null) {
            try {
                if (tenantId) {
                    // Update
                    const { error } = await supabase
                        .from('tenants')
                        .update(tenantData)
                        .eq('id', tenantId)
                        .eq('user_id', currentUser.id);
                    
                    if (error) throw error;
                    alert('Tenant updated successfully!');
                    
                } else {
                    // Create
                    const { error } = await supabase
                        .from('tenants')
                        .insert([tenantData]);
                    
                    if (error) throw error;
                    alert('Tenant added successfully!');
                }
                
                closeModal();
                loadTenants();
                
            } catch (error) {
                console.error('Error saving tenant:', error);
                alert('Error: ' + error.message);
            }
        }
        
        // Delete tenant
        async function deleteTenant(tenantId) {
            if (!confirm('Are you sure you want to delete this tenant?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('tenants')
                    .delete()
                    .eq('id', tenantId)
                    .eq('user_id', currentUser.id);
                
                if (error) throw error;
                
                alert('Tenant deleted successfully!');
                loadTenants();
                
            } catch (error) {
                console.error('Error deleting tenant:', error);
                alert('Error deleting tenant');
            }
        }
        
        // Toggle sidebar for mobile
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }
        
        // Logout function
        async function logout() {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
