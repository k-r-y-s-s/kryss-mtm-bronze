<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenants - My Tenant Manager</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞ Menu</button>
    
    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>üè† My Tenant Manager</h2>
            <p class="sidebar-subtitle">Tenants Management</p>
        </div>
        
        <nav class="sidebar-nav">
            <a href="dashboard.html" class="nav-link">
                <span class="nav-icon">üìä</span>
                <span>Dashboard</span>
            </a>
            <a href="tenants.html" class="nav-link active">
                <span class="nav-icon">üë•</span>
                <span>Tenants</span>
            </a>
            <a href="utilities.html" class="nav-link">
                <span class="nav-icon">‚ö°</span>
                <span>Utilities</span>
            </a>
            <a href="rent.html" class="nav-link">
                <span class="nav-icon">üí∞</span>
                <span>Rent</span>
            </a>
            <a href="payments.html" class="nav-link">
                <span class="nav-icon">üí≥</span>
                <span>Payments</span>
            </a>
            <a href="ledger.html" class="nav-link">
                <span class="nav-icon">üìí</span>
                <span>Ledger</span>
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <button onclick="logout()" class="btn btn-outline" style="width: 100%;">
                üö™ Logout
            </button>
        </div>
    </div>
    
    <!-- MAIN CONTENT -->
    <div class="main-content">
        <div class="page-header">
            <div>
                <h1>üë• Tenants Management</h1>
                <p class="small-text">Core feature - Add, edit, and manage all tenants</p>
            </div>
            <button onclick="showAddTenantModal()" class="btn btn-primary">
                Ôºã Add New Tenant
            </button>
        </div>
        
        <!-- DESKTOP: Table Layout -->
        <div class="table-container" id="desktopTable">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Monthly Rent</th>
                        <th>Due Day</th>
                        <th>Utilities</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tenantsTableBody">
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem;">
                            Loading tenants...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- MOBILE: Stacked Layout -->
        <div class="table-container mobile-stacked hidden" id="mobileTable">
            <table class="data-table">
                <tbody id="mobileTenantsTableBody">
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- ============================================
         MODAL 1: ADD/EDIT TENANT FORM
         ============================================ -->
    <div class="modal-overlay hidden" id="tenantModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">Add New Tenant</h3>
                <button class="close-modal" onclick="closeTenantModal()">√ó</button>
            </div>
            
            <div class="modal-body">
                <form id="tenantForm">
                    <input type="hidden" id="tenantId">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="tenantName">Full Name *</label>
                            <input type="text" id="tenantName" required placeholder="Juan Dela Cruz">
                        </div>
                        <div class="form-group">
                            <label for="monthlyRent">Monthly Rent (‚Ç±) *</label>
                            <input type="number" id="monthlyRent" required min="0" step="0.01" placeholder="5000.00">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="rentDueDay">Rent Due Day (1-31) *</label>
                            <input type="number" id="rentDueDay" required min="1" max="31" placeholder="15">
                        </div>
                        <div class="form-group">
                            <label for="tenantStatus">Status *</label>
                            <select id="tenantStatus" required>
                                <option value="active">Active</option>
                                <option value="moved_out">Moved Out</option>
                                <option value="left_without_notice">Left Without Notice</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Conditional Fields for Status -->
                    <div id="statusConditionalFields" style="display: none; margin-bottom: 1.5rem;">
                        <!-- Will be shown based on status selection -->
                    </div>
                    
                    <div class="form-group">
                        <label>Utilities Assigned *</label>
                        <p class="small-text">Select utilities this tenant is responsible for:</p>
                        <div class="checkbox-group">
                            <label>
                                <input type="checkbox" id="hasElectric" value="electric">
                                Electric
                            </label>
                            <label>
                                <input type="checkbox" id="hasWater" value="water">
                                Water
                            </label>
                            <label>
                                <input type="checkbox" id="hasWifi" value="wifi">
                                Wi-Fi
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="tenantNotes">Notes</label>
                        <textarea id="tenantNotes" rows="3" placeholder="Additional information about the tenant..."></textarea>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeTenantModal()">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" id="modalSubmitBtn">
                            Save Tenant
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- ============================================
         MODAL 2: DATA CONSENT WARNING (Strict Order as Specified)
         ============================================ -->
    <div class="modal-overlay hidden" id="consentModal">
        <div class="modal">
            <div class="modal-header" style="background: #fef3c7; border-left: 4px solid #f59e0b;">
                <h3>‚ö†Ô∏è Data Consent Required</h3>
                <button class="close-modal" onclick="closeConsentModal()">√ó</button>
            </div>
            
            <div class="modal-body">
                <div class="consent-warning">
                    <h4>Philippine Data Privacy Act of 2012 Compliance</h4>
                    <p><strong>Important:</strong> Before adding a tenant, you must confirm:</p>
                    <ul>
                        <li>You have obtained consent from the tenant to collect their personal information</li>
                        <li>You will use this data only for rental management purposes</li>
                        <li>You will implement reasonable security measures to protect this data</li>
                        <li>You understand your obligations under the Data Privacy Act</li>
                    </ul>
                    <p><strong>For Cebu Landlords:</strong> This applies to all rental agreements in Cebu City.</p>
                </div>
                
                <div style="padding: 1rem; background: #f9fafb; border-radius: 0.375rem; margin: 1.5rem 0;">
                    <label style="display: flex; align-items: start; gap: 0.5rem;">
                        <input type="checkbox" id="confirmConsent" required style="margin-top: 0.25rem;">
                        <div>
                            <strong>I confirm that I have obtained proper consent</strong>
                            <p class="small-text" style="margin-top: 0.25rem;">
                                I have the legal right to collect and store this tenant information for rental management purposes.
                            </p>
                        </div>
                    </label>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeConsentModal()">
                        Cancel (Do Not Save)
                    </button>
                    <button type="button" class="btn btn-primary" onclick="confirmDataConsent()">
                        I Confirm & Continue
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============================================
         MODAL 3: DELETE CONFIRMATION
         ============================================ -->
    <div class="modal-overlay hidden" id="deleteModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Delete Tenant</h3>
                <button class="close-modal" onclick="closeDeleteModal()">√ó</button>
            </div>
            
            <div class="modal-body">
                <p><strong>Warning:</strong> Deleting this tenant will also remove:</p>
                <ul style="margin: 1rem 0 1rem 1.5rem;">
                    <li>All utility records for this tenant</li>
                    <li>All rent charges for this tenant</li>
                    <li>All payment records for this tenant</li>
                    <li>All ledger entries for this tenant</li>
                </ul>
                <p>This action cannot be undone.</p>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-primary" style="background: #dc2626;" onclick="confirmDeleteTenant()">
                        Delete Permanently
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://hnjlrjtiomdqcqznkuxh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhuamxyanRpb21kcWNxem5rdXhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4NDQ5MTUsImV4cCI6MjA4NTQyMDkxNX0.iW9E91LYLNSkpjiITNcXa7Zj1rpcw8euriHkgfQ19dQ';
        const supabase = supabaseClient.createClient(supabaseUrl, supabaseKey);
        
        let currentUser = null;
        let currentTenantId = null;
        let pendingTenantData = null;
        let tenantToDeleteId = null;
        
        // Check authentication
        supabase.auth.getSession().then(async ({ data: { session } }) => {
            if (!session) {
                window.location.href = 'login.html';
            } else {
                currentUser = session.user;
                await loadTenants();
                
                // Setup mobile/desktop view based on screen size
                setupResponsiveTables();
                window.addEventListener('resize', setupResponsiveTables);
            }
        });
        
        // Setup responsive tables (Desktop: Table, Mobile: Stacked)
        function setupResponsiveTables() {
            const desktopTable = document.getElementById('desktopTable');
            const mobileTable = document.getElementById('mobileTable');
            
            if (window.innerWidth <= 1024) {
                // Mobile view
                desktopTable.classList.add('hidden');
                mobileTable.classList.remove('hidden');
            } else {
                // Desktop view
                desktopTable.classList.remove('hidden');
                mobileTable.classList.add('hidden');
            }
        }
        
        // Load tenants
        async function loadTenants() {
            try {
                const { data: tenants, error } = await supabase
                    .from('tenants')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                updateTenantsTable(tenants || []);
                updateMobileTenantsTable(tenants || []);
                
            } catch (error) {
                console.error('Error loading tenants:', error);
                showError('Failed to load tenants');
            }
        }
        
        // Update desktop table
        function updateTenantsTable(tenants) {
            const tbody = document.getElementById('tenantsTableBody');
            
            if (tenants.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem;">
                            No tenants yet. Click "Add New Tenant" to get started.
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            tenants.forEach(tenant => {
                // Format utilities
                let utilities = '';
                if (tenant.has_electric) utilities += '‚ö° ';
                if (tenant.has_water) utilities += 'üíß ';
                if (tenant.has_wifi) utilities += 'üì∂ ';
                if (!utilities) utilities = 'None';
                
                // Status pill (EXACT colors as specified)
                let statusClass, statusText;
                if (tenant.status === 'active') {
                    statusClass = 'status-active';
                    statusText = 'Active';
                } else if (tenant.status === 'moved_out') {
                    statusClass = 'status-moved-out';
                    statusText = 'Moved Out';
                } else {
                    statusClass = 'status-left';
                    statusText = 'Left Without Notice';
                }
                
                html += `
                    <tr>
                        <td><strong>${tenant.name}</strong></td>
                        <td class="currency">‚Ç±${parseFloat(tenant.monthly_rent).toLocaleString('en-PH', { minimumFractionDigits: 2 })}</td>
                        <td>${tenant.rent_due_day}th of month</td>
                        <td>${utilities}</td>
                        <td><span class="status-pill ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="action-btn edit" onclick="editTenant('${tenant.id}')">
                                Edit
                            </button>
                            <button class="action-btn delete" onclick="showDeleteModal('${tenant.id}')">
                                Delete
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Update mobile stacked table
        function updateMobileTenantsTable(tenants) {
            const tbody = document.getElementById('mobileTenantsTableBody');
            
            if (tenants.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="1" style="text-align: center; padding: 2rem;">
                            No tenants yet. Click "Add New Tenant" to get started.
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            tenants.forEach(tenant => {
                // Format utilities
                let utilities = '';
                if (tenant.has_electric) utilities += '‚ö° ';
                if (tenant.has_water) utilities += 'üíß ';
                if (tenant.has_wifi) utilities += 'üì∂ ';
                if (!utilities) utilities = 'None';
                
                // Status pill
                let statusClass, statusText;
                if (tenant.status === 'active') {
                    statusClass = 'status-active';
                    statusText = 'Active';
                } else if (tenant.status === 'moved_out') {
                    statusClass = 'status-moved-out';
                    statusText = 'Moved Out';
                } else {
                    statusClass = 'status-left';
                    statusText = 'Left Without Notice';
                }
                
                html += `
                    <tr>
                        <td data-label="Tenant">
                            <div style="margin-bottom: 1rem;">
                                <strong>${tenant.name}</strong>
                                <span class="status-pill ${statusClass}" style="margin-left: 0.5rem;">${statusText}</span>
                            </div>
                            <div style="display: grid; gap: 0.5rem;">
                                <div><strong>Rent:</strong> ‚Ç±${parseFloat(tenant.monthly_rent).toLocaleString('en-PH', { minimumFractionDigits: 2 })}</div>
                                <div><strong>Due Day:</strong> ${tenant.rent_due_day}th of month</div>
                                <div><strong>Utilities:</strong> ${utilities}</div>
                                <div style="margin-top: 0.5rem;">
                                    <button class="action-btn edit" onclick="editTenant('${tenant.id}')" style="margin-right: 0.5rem;">
                                        Edit
                                    </button>
                                    <button class="action-btn delete" onclick="showDeleteModal('${tenant.id}')">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // ============================================
        // ADD TENANT FLOW (STRICT ORDER as specified)
        // ============================================
        
        // 1. Click Add Tenant
        function showAddTenantModal() {
            currentTenantId = null;
            document.getElementById('modalTitle').textContent = 'Add New Tenant';
            document.getElementById('modalSubmitBtn').textContent = 'Save Tenant';
            document.getElementById('tenantForm').reset();
            document.getElementById('tenantStatus').value = 'active';
            document.getElementById('statusConditionalFields').style.display = 'none';
            
            document.getElementById('tenantModal').classList.remove('hidden');
        }
        
        // Handle status change for conditional fields
        document.getElementById('tenantStatus').addEventListener('change', function() {
            const status = this.value;
            const conditionalFields = document.getElementById('statusConditionalFields');
            
            if (status === 'moved_out') {
                conditionalFields.innerHTML = `
                    <div class="form-group">
                        <label for="movedOutDate">Moved Out Date *</label>
                        <input type="date" id="movedOutDate" required>
                    </div>
                `;
                conditionalFields.style.display = 'block';
            } else if (status === 'left_without_notice') {
                conditionalFields.innerHTML = `
                    <div class="form-group">
                        <label for="lastSeenDate">Last Seen Date *</label>
                        <input type="date" id="lastSeenDate" required>
                    </div>
                `;
                conditionalFields.style.display = 'block';
            } else {
                conditionalFields.style.display = 'none';
            }
        });
        
        // 2. Show tenant form (already shown in modal)
        // 3. Show warning modal (data consent)
        document.getElementById('tenantForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Collect form data
            const formData = {
                name: document.getElementById('tenantName').value,
                monthly_rent: parseFloat(document.getElementById('monthlyRent').value),
                rent_due_day: parseInt(document.getElementById('rentDueDay').value),
                status: document.getElementById('tenantStatus').value,
                has_electric: document.getElementById('hasElectric').checked,
                has_water: document.getElementById('hasWater').checked,
                has_wifi: document.getElementById('hasWifi').checked,
                notes: document.getElementById('tenantNotes').value
            };
            
            // Add conditional fields if applicable
            const status = formData.status;
            if (status === 'moved_out') {
                formData.moved_out_date = document.getElementById('movedOutDate').value;
            } else if (status === 'left_without_notice') {
                formData.last_seen_date = document.getElementById('lastSeenDate').value;
            }
            
            // For new tenants, show consent modal
            if (!currentTenantId) {
                pendingTenantData = formData;
                closeTenantModal();
                document.getElementById('consentModal').classList.remove('hidden');
            } else {
                // For editing, save directly
                saveTenant(formData, currentTenantId);
            }
        });
        
        // 4. User confirms consent
        function confirmDataConsent() {
            const confirmCheckbox = document.getElementById('confirmConsent');
            
            if (!confirmCheckbox.checked) {
                alert('You must confirm data consent to proceed.');
                return;
            }
            
            closeConsentModal();
            
            // 5. Save to database
            if (pendingTenantData) {
                saveTenant(pendingTenantData);
                pendingTenantData = null;
            }
        }
        
        // Save tenant to database
        async function saveTenant(tenantData, tenantId = null) {
            try {
                const dataToSave = {
                    ...tenantData,
                    user_id: currentUser.id
                };
                
                if (tenantId) {
                    // Update existing tenant
                    const { error } = await supabase
                        .from('tenants')
                        .update(dataToSave)
                        .eq('id', tenantId)
                        .eq('user_id', currentUser.id);
                    
                    if (error) throw error;
                    showSuccess('Tenant updated successfully!');
                } else {
                    // Create new tenant
                    const { error } = await supabase
                        .from('tenants')
                        .insert([dataToSave]);
                    
                    if (error) throw error;
                    showSuccess('Tenant added successfully!');
                }
                
                // 6. Show success feedback
                await loadTenants();
                
            } catch (error) {
                console.error('Error saving tenant:', error);
                showError('Failed to save tenant: ' + error.message);
            }
        }
        
        // ============================================
        // EDIT TENANT
        // ============================================
        async function editTenant(tenantId) {
            try {
                const { data: tenant, error } = await supabase
                    .from('tenants')
                    .select('*')
                    .eq('id', tenantId)
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (error) throw error;
                
                currentTenantId = tenantId;
                document.getElementById('modalTitle').textContent = 'Edit Tenant';
                document.getElementById('modalSubmitBtn').textContent = 'Update Tenant';
                
                // Fill form
                document.getElementById('tenantId').value = tenant.id;
                document.getElementById('tenantName').value = tenant.name;
                document.getElementById('monthlyRent').value = tenant.monthly_rent;
                document.getElementById('rentDueDay').value = tenant.rent_due_day;
                document.getElementById('tenantStatus').value = tenant.status;
                document.getElementById('hasElectric').checked = tenant.has_electric;
                document.getElementById('hasWater').checked = tenant.has_water;
                document.getElementById('hasWifi').checked = tenant.has_wifi;
                document.getElementById('tenantNotes').value = tenant.notes || '';
                
                // Handle conditional fields
                const status = tenant.status;
                const conditionalFields = document.getElementById('statusConditionalFields');
                
                if (status === 'moved_out' && tenant.moved_out_date) {
                    conditionalFields.innerHTML = `
                        <div class="form-group">
                            <label for="movedOutDate">Moved Out Date *</label>
                            <input type="date" id="movedOutDate" value="${tenant.moved_out_date}" required>
                        </div>
                    `;
                    conditionalFields.style.display = 'block';
                } else if (status === 'left_without_notice' && tenant.last_seen_date) {
                    conditionalFields.innerHTML = `
                        <div class="form-group">
                            <label for="lastSeenDate">Last Seen Date *</label>
                            <input type="date" id="lastSeenDate" value="${tenant.last_seen_date}" required>
                        </div>
                    `;
                    conditionalFields.style.display = 'block';
                } else {
                    conditionalFields.style.display = 'none';
                }
                
                document.getElementById('tenantModal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading tenant:', error);
                showError('Failed to load tenant data');
            }
        }
        
        // ============================================
        // DELETE TENANT
        // ============================================
        function showDeleteModal(tenantId) {
            tenantToDeleteId = tenantId;
            document.getElementById('deleteModal').classList.remove('hidden');
        }
        
        async function confirmDeleteTenant() {
            try {
                const { error } = await supabase
                    .from('tenants')
                    .delete()
                    .eq('id', tenantToDeleteId)
                    .eq('user_id', currentUser.id);
                
                if (error) throw error;
                
                showSuccess('Tenant deleted successfully!');
                closeDeleteModal();
                await loadTenants();
                
            } catch (error) {
                console.error('Error deleting tenant:', error);
                showError('Failed to delete tenant');
            }
        }
        
        // ============================================
        // MODAL MANAGEMENT
        // ============================================
        function closeTenantModal() {
            document.getElementById('tenantModal').classList.add('hidden');
            currentTenantId = null;
        }
        
        function closeConsentModal() {
            document.getElementById('consentModal').classList.add('hidden');
            document.getElementById('confirmConsent').checked = false;
            pendingTenantData = null;
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
            tenantToDeleteId = null;
        }
        
        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        function showSuccess(message) {
            alert('‚úì ' + message);
        }
        
        function showError(message) {
            alert('‚úó ' + message);
        }
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }
        
        async function logout() {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        }
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const mobileBtn = document.querySelector('.mobile-menu-btn');
            
            if (window.innerWidth <= 1024 && 
                !sidebar.contains(event.target) && 
                event.target !== mobileBtn) {
                sidebar.classList.remove('active');
            }
        });
    </script>
</body>
</html>
