<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ledger - My Tenant Manager</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- PDF Export Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞ Menu</button>
    
    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>üè† My Tenant Manager</h2>
            <p class="sidebar-subtitle">Complete Ledger System</p>
        </div>
        
        <nav class="sidebar-nav">
            <a href="dashboard.html" class="nav-link">
                <span class="nav-icon">üìä</span>
                <span>Dashboard</span>
            </a>
            <a href="tenants.html" class="nav-link">
                <span class="nav-icon">üë•</span>
                <span>Tenants</span>
            </a>
            <a href="utilities.html" class="nav-link">
                <span class="nav-icon">‚ö°</span>
                <span>Utilities</span>
            </a>
            <a href="rent.html" class="nav-link">
                <span class="nav-icon">üí∞</span>
                <span>Rent</span>
            </a>
            <a href="payments.html" class="nav-link">
                <span class="nav-icon">üí≥</span>
                <span>Payments</span>
            </a>
            <a href="ledger.html" class="nav-link active">
                <span class="nav-icon">üìí</span>
                <span>Ledger</span>
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <button onclick="logout()" class="btn btn-outline" style="width: 100%;">
                üö™ Logout
            </button>
        </div>
    </div>
    
    <!-- MAIN CONTENT -->
    <div class="main-content">
        <div class="page-header">
            <div>
                <h1>üìí Ledger System</h1>
                <p class="small-text">General ledger + Tenant-specific ledgers with running balance</p>
            </div>
            <div>
                <button onclick="showExportOptions()" class="btn btn-secondary">
                    üì• Export
                </button>
            </div>
        </div>
        
        <!-- View Toggle -->
        <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 1rem;">
            <button id="viewGeneral" class="btn btn-primary" onclick="switchView('general')">
                General Ledger
            </button>
            <button id="viewTenant" class="btn btn-outline" onclick="switchView('tenant')">
                Tenant Ledger
            </button>
        </div>
        
        <!-- ============================================
             GENERAL LEDGER VIEW
             ============================================ -->
        <div id="generalLedgerView">
            <!-- Filter Options -->
            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                <select id="filterType" onchange="filterGeneralLedger()" class="form-group" style="flex: 1; min-width: 150px;">
                    <option value="">All Types</option>
                    <option value="charge">Charges</option>
                    <option value="payment">Payments</option>
                </select>
                <select id="filterCategory" onchange="filterGeneralLedger()" class="form-group" style="flex: 1; min-width: 150px;">
                    <option value="">All Categories</option>
                    <option value="rent">Rent</option>
                    <option value="electric">Electric</option>
                    <option value="water">Water</option>
                    <option value="wifi">Wi-Fi</option>
                    <option value="other">Other</option>
                </select>
                <input type="date" id="filterDateFrom" onchange="filterGeneralLedger()" class="form-group" style="flex: 1; min-width: 150px;" placeholder="From Date">
                <input type="date" id="filterDateTo" onchange="filterGeneralLedger()" class="form-group" style="flex: 1; min-width: 150px;" placeholder="To Date">
                <button onclick="resetGeneralFilters()" class="btn btn-outline" style="height: fit-content; align-self: flex-end;">
                    Reset
                </button>
            </div>
            
            <!-- General Ledger Table -->
            <div class="table-container">
                <div class="table-header">
                    <h2>üìã General Ledger</h2>
                    <span class="small-text">All transactions chronological</span>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Tenant</th>
                            <th>Type</th>
                            <th>Category</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody id="generalLedgerTableBody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem;">
                                Loading general ledger...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Summary Stats -->
            <div class="stats-grid" style="margin-top: 2rem;">
                <div class="stat-card">
                    <h3>Total Charges</h3>
                    <div class="stat-number currency-negative" id="totalCharges">‚Ç±0.00</div>
                    <span class="stat-trend">Rent + Utilities</span>
                </div>
                <div class="stat-card">
                    <h3>Total Payments</h3>
                    <div class="stat-number currency-positive" id="totalPayments">‚Ç±0.00</div>
                    <span class="stat-trend">Received</span>
                </div>
                <div class="stat-card">
                    <h3>Net Balance</h3>
                    <div class="stat-number" id="netBalance">‚Ç±0.00</div>
                    <span class="stat-trend">Current</span>
                </div>
            </div>
        </div>
        
        <!-- ============================================
             TENANT LEDGER VIEW
             ============================================ -->
        <div id="tenantLedgerView" style="display: none;">
            <!-- Tenant Selection -->
            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; align-items: flex-end; flex-wrap: wrap;">
                <div class="form-group" style="flex: 1; min-width: 300px;">
                    <label for="selectTenant">Select Tenant</label>
                    <select id="selectTenant" onchange="loadTenantLedger()" style="width: 100%;">
                        <option value="">Select a tenant...</option>
                    </select>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="date" id="tenantDateFrom" onchange="loadTenantLedger()" class="form-group" style="flex: 1; min-width: 150px;" placeholder="From Date">
                    <input type="date" id="tenantDateTo" onchange="loadTenantLedger()" class="form-group" style="flex: 1; min-width: 150px;" placeholder="To Date">
                    <button onclick="resetTenantFilters()" class="btn btn-outline" style="height: fit-content;">
                        Reset
                    </button>
                </div>
            </div>
            
            <!-- Tenant Info Card -->
            <div id="tenantInfoCard" style="display: none; margin-bottom: 1.5rem;">
                <div class="stat-card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 id="tenantName">Loading...</h3>
                            <p class="small-text" id="tenantDetails">Monthly rent: ‚Ç±0.00 | Due day: 0th</p>
                        </div>
                        <div style="text-align: right;">
                            <div class="stat-number" id="tenantCurrentBalance">‚Ç±0.00</div>
                            <span class="stat-trend" id="tenantBalanceStatus">Current balance</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tenant Ledger Table -->
            <div class="table-container">
                <div class="table-header">
                    <h2>üë§ Tenant Ledger</h2>
                    <span class="small-text" id="tenantLedgerSubtitle">Filtered by tenant with running balance</span>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Category</th>
                            <th>Description</th>
                            <th>Charge</th>
                            <th>Payment</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody id="tenantLedgerTableBody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem;">
                                Select a tenant to view their ledger.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Mobile-friendly ledger view -->
            <div class="table-container mobile-stacked hidden" style="margin-top: 1rem;">
                <table class="data-table">
                    <tbody id="mobileTenantLedgerBody">
                        <!-- Will be populated for mobile -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- ============================================
         MODAL 1: TRANSACTION DETAILS
         ============================================ -->
    <div class="modal-overlay hidden" id="transactionModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Transaction Details</h3>
                <button class="close-modal" onclick="closeTransactionModal()">√ó</button>
            </div>
            
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <h4 id="transactionTitle">Loading...</h4>
                    <p class="small-text" id="transactionDate">Date: Loading...</p>
                </div>
                
                <div style="display: grid; gap: 1rem;">
                    <div>
                        <strong>Tenant:</strong>
                        <p id="transactionTenant">Loading...</p>
                    </div>
                    <div>
                        <strong>Type:</strong>
                        <span id="transactionType" class="status-pill">Loading</span>
                    </div>
                    <div>
                        <strong>Category:</strong>
                        <span id="transactionCategory" class="status-pill">Loading</span>
                    </div>
                    <div>
                        <strong>Amount:</strong>
                        <p id="transactionAmount" class="currency">Loading...</p>
                    </div>
                    <div>
                        <strong>Description:</strong>
                        <p id="transactionDescription">Loading...</p>
                    </div>
                    <div>
                        <strong>Running Balance:</strong>
                        <p id="transactionBalance" class="currency">Loading...</p>
                    </div>
                    <div id="transactionNotes" style="display: none;">
                        <strong>Notes:</strong>
                        <p id="transactionNotesContent">Loading...</p>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeTransactionModal()">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============================================
         MODAL 2: EXPORT OPTIONS
         ============================================ -->
    <div class="modal-overlay hidden" id="exportModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3>üì• Export Options</h3>
                <button class="close-modal" onclick="closeExportModal()">√ó</button>
            </div>
            
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <h4>Select Export Format</h4>
                    <p class="small-text">Choose the format and scope for your ledger export</p>
                </div>
                
                <div style="display: grid; gap: 1rem; margin-bottom: 1.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; border: 1px solid #ddd; border-radius: 0.375rem;">
                        <input type="radio" name="exportFormat" value="csv" checked>
                        <div>
                            <div style="font-weight: 500;">CSV (Excel)</div>
                            <p class="small-text" style="margin-top: 0.25rem;">Export as spreadsheet for Excel/Google Sheets</p>
                        </div>
                    </label>
                    
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; border: 1px solid #ddd; border-radius: 0.375rem;">
                        <input type="radio" name="exportFormat" value="pdf">
                        <div>
                            <div style="font-weight: 500;">PDF Document</div>
                            <p class="small-text" style="margin-top: 0.25rem;">Export as printable PDF document</p>
                        </div>
                    </label>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <h5>Export Scope</h5>
                    <div style="display: flex; gap: 1rem;">
                        <label style="flex: 1;">
                            <input type="radio" name="exportScope" value="current" checked>
                            Current View
                        </label>
                        <label style="flex: 1;">
                            <input type="radio" name="exportScope" value="all">
                            All Data
                        </label>
                    </div>
                    <p class="small-text" style="margin-top: 0.5rem;">
                        <span id="exportScopeDescription">Export currently filtered data</span>
                    </p>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeExportModal()">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-primary" onclick="performExport()" id="exportBtn">
                        Export
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Initialize Supabase - FIXED: Changed variable name to avoid conflict
        const supabaseUrl = 'https://hnjlrjtiomdqcqznkuxh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhuamxyanRpb21kcWNxem5rdXhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4NDQ5MTUsImV4cCI6MjA4NTQyMDkxNX0.iW9E91LYLNSkpjiITNcXa7Zj1rpcw8euriHkgfQ19dQ';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        
        let currentUser = null;
        let allLedgerEntries = [];
        let allTenants = [];
        let currentView = 'general';
        let selectedTenantId = null;
        let currentFilteredEntries = [];
        let currentTenantEntries = [];
        
        // Check authentication
        supabaseClient.auth.getSession().then(async ({ data: { session } }) => {
            if (!session) {
                window.location.href = 'login.html';
            } else {
                currentUser = session.user;
                await loadTenants();
                await loadGeneralLedger();
                
                // Check if tenant ID is stored from dashboard
                const storedTenantId = localStorage.getItem('selectedTenantId');
                if (storedTenantId) {
                    localStorage.removeItem('selectedTenantId');
                    switchView('tenant');
                    document.getElementById('selectTenant').value = storedTenantId;
                    loadTenantLedger();
                }
                
                // Setup mobile/desktop view
                setupResponsiveLedger();
                window.addEventListener('resize', setupResponsiveLedger);
                
                // Setup export scope listeners
                document.querySelectorAll('input[name="exportScope"]').forEach(radio => {
                    radio.addEventListener('change', updateExportScopeDescription);
                });
            }
        });
        
        // Setup responsive ledger tables
        function setupResponsiveLedger() {
            const desktopTable = document.querySelector('#tenantLedgerView .table-container');
            const mobileTable = document.querySelector('#tenantLedgerView .mobile-stacked');
            
            if (desktopTable && mobileTable) {
                if (window.innerWidth <= 1024) {
                    // Mobile view
                    desktopTable.classList.add('hidden');
                    mobileTable.classList.remove('hidden');
                } else {
                    // Desktop view
                    desktopTable.classList.remove('hidden');
                    mobileTable.classList.add('hidden');
                }
            }
        }
        
        // Load tenants for dropdown
        async function loadTenants() {
            try {
                const { data: tenants, error } = await supabaseClient
                    .from('tenants')
                    .select('id, name, monthly_rent, rent_due_day, status')
                    .eq('user_id', currentUser.id)
                    .order('name');
                
                if (error) throw error;
                
                allTenants = tenants || [];
                
                // Update tenant dropdown
                const select = document.getElementById('selectTenant');
                select.innerHTML = '<option value="">Select a tenant...</option>';
                
                tenants.forEach(tenant => {
                    const status = tenant.status === 'active' ? 'Active' : 
                                  tenant.status === 'moved_out' ? 'Moved Out' : 'Left';
                    
                    select.innerHTML += `
                        <option value="${tenant.id}">
                            ${tenant.name} (${status}) - ‚Ç±${parseFloat(tenant.monthly_rent || 0).toLocaleString('en-PH')}
                        </option>
                    `;
                });
                
            } catch (error) {
                console.error('Error loading tenants:', error);
                alert('Failed to load tenants: ' + error.message);
            }
        }
        
        // Load general ledger entries
        async function loadGeneralLedger() {
            try {
                const { data: ledgerEntries, error } = await supabaseClient
                    .from('ledger_entries')
                    .select(`
                        *,
                        tenants(name)
                    `)
                    .eq('user_id', currentUser.id)
                    .order('entry_date', { ascending: false })
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                allLedgerEntries = ledgerEntries || [];
                currentFilteredEntries = [...allLedgerEntries];
                filterGeneralLedger();
                
            } catch (error) {
                console.error('Error loading ledger entries:', error);
                alert('Failed to load ledger entries: ' + error.message);
            }
        }
        
        // ============================================
        // GENERAL LEDGER FUNCTIONS
        // ============================================
        
        // Switch between general and tenant views
        function switchView(view) {
            currentView = view;
            
            const generalView = document.getElementById('generalLedgerView');
            const tenantView = document.getElementById('tenantLedgerView');
            const generalBtn = document.getElementById('viewGeneral');
            const tenantBtn = document.getElementById('viewTenant');
            
            if (view === 'general') {
                generalView.style.display = 'block';
                tenantView.style.display = 'none';
                generalBtn.className = 'btn btn-primary';
                tenantBtn.className = 'btn btn-outline';
            } else {
                generalView.style.display = 'none';
                tenantView.style.display = 'block';
                generalBtn.className = 'btn btn-outline';
                tenantBtn.className = 'btn btn-primary';
            }
        }
        
        // Filter general ledger
        function filterGeneralLedger() {
            const type = document.getElementById('filterType').value;
            const category = document.getElementById('filterCategory').value;
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;
            
            let filtered = allLedgerEntries;
            
            if (type) {
                filtered = filtered.filter(entry => entry.type === type);
            }
            
            if (category) {
                filtered = filtered.filter(entry => entry.category === category);
            }
            
            if (dateFrom) {
                filtered = filtered.filter(entry => entry.entry_date >= dateFrom);
            }
            
            if (dateTo) {
                filtered = filtered.filter(entry => entry.entry_date <= dateTo);
            }
            
            currentFilteredEntries = [...filtered];
            updateGeneralLedgerTable(filtered);
            updateGeneralSummary(filtered);
        }
        
        // Reset general filters
        function resetGeneralFilters() {
            document.getElementById('filterType').value = '';
            document.getElementById('filterCategory').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            filterGeneralLedger();
        }
        
        // Update general ledger table
        function updateGeneralLedgerTable(entries) {
            const tbody = document.getElementById('generalLedgerTableBody');
            
            if (!entries || entries.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem;">
                            üì≠ No ledger entries found.
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort by date (chronological)
            entries.sort((a, b) => new Date(a.entry_date) - new Date(b.entry_date));
            
            let html = '';
            entries.forEach(entry => {
                const date = new Date(entry.entry_date);
                
                // Type styling
                let typeClass, typeText;
                if (entry.type === 'charge') {
                    typeClass = 'status-moved-out';
                    typeText = 'Charge';
                } else {
                    typeClass = 'status-active';
                    typeText = 'Payment';
                }
                
                // Category styling
                let categoryClass;
                if (entry.category === 'rent') categoryClass = 'status-active';
                else if (entry.category === 'electric') categoryClass = 'status-moved-out';
                else if (entry.category === 'water') categoryClass = 'status-left';
                else categoryClass = '';
                
                // Amount styling
                const amountClass = entry.type === 'charge' ? 'currency-negative' : 'currency-positive';
                const amountSign = entry.type === 'charge' ? '-' : '+';
                
                html += `
                    <tr onclick="showTransactionDetails('${entry.id}')" style="cursor: pointer;">
                        <td>${date.toLocaleDateString('en-PH')}</td>
                        <td>${entry.tenants?.name || 'N/A'}</td>
                        <td>
                            <span class="status-pill ${typeClass}">
                                ${typeText}
                            </span>
                        </td>
                        <td>
                            <span class="status-pill ${categoryClass}">
                                ${entry.category ? entry.category.charAt(0).toUpperCase() + entry.category.slice(1) : 'Other'}
                            </span>
                        </td>
                        <td>${entry.description || ''}</td>
                        <td class="currency ${amountClass}">
                            ${amountSign}‚Ç±${parseFloat(entry.amount || 0).toLocaleString('en-PH', { minimumFractionDigits: 2 })}
                        </td>
                        <td class="currency">
                            ‚Ç±${entry.running_balance ? parseFloat(entry.running_balance).toLocaleString('en-PH', { minimumFractionDigits: 2 }) : '0.00'}
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Update general ledger summary
        function updateGeneralSummary(entries = allLedgerEntries) {
            let totalCharges = 0;
            let totalPayments = 0;
            
            entries.forEach(entry => {
                const amount = parseFloat(entry.amount || 0);
                if (entry.type === 'charge') {
                    totalCharges += amount;
                } else {
                    totalPayments += amount;
                }
            });
            
            const netBalance = totalCharges - totalPayments;
            
            document.getElementById('totalCharges').textContent = 
                '‚Ç±' + totalCharges.toLocaleString('en-PH', { minimumFractionDigits: 2 });
            document.getElementById('totalPayments').textContent = 
                '‚Ç±' + totalPayments.toLocaleString('en-PH', { minimumFractionDigits: 2 });
            
            const netBalanceElement = document.getElementById('netBalance');
            netBalanceElement.textContent = 
                '‚Ç±' + Math.abs(netBalance).toLocaleString('en-PH', { minimumFractionDigits: 2 });
            
            if (netBalance > 0) {
                netBalanceElement.className = 'stat-number currency-negative';
                netBalanceElement.innerHTML = '‚Ç±' + Math.abs(netBalance).toLocaleString('en-PH', { minimumFractionDigits: 2 }) + ' <span style="color: #991b1b; font-size: 0.75em;">(Due)</span>';
            } else if (netBalance < 0) {
                netBalanceElement.className = 'stat-number currency-positive';
                netBalanceElement.innerHTML = '‚Ç±' + Math.abs(netBalance).toLocaleString('en-PH', { minimumFractionDigits: 2 }) + ' <span style="color: #065f46; font-size: 0.75em;">(Credit)</span>';
            } else {
                netBalanceElement.className = 'stat-number';
                netBalanceElement.textContent = '‚Ç±0.00';
            }
        }
        
        // ============================================
        // TENANT LEDGER FUNCTIONS
        // ============================================
        
        // Load tenant ledger
        async function loadTenantLedger() {
            const tenantId = document.getElementById('selectTenant').value;
            const dateFrom = document.getElementById('tenantDateFrom').value;
            const dateTo = document.getElementById('tenantDateTo').value;
            
            if (!tenantId) {
                document.getElementById('tenantInfoCard').style.display = 'none';
                document.getElementById('tenantLedgerTableBody').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem;">
                            Select a tenant to view their ledger.
                        </td>
                    </tr>
                `;
                document.getElementById('mobileTenantLedgerBody').innerHTML = `
                    <tr>
                        <td style="text-align: center; padding: 2rem;">
                            Select a tenant to view their ledger.
                        </td>
                    </tr>
                `;
                return;
            }
            
            selectedTenantId = tenantId;
            
            try {
                // Load tenant info
                const { data: tenant, error: tenantError } = await supabaseClient
                    .from('tenants')
                    .select('*')
                    .eq('id', tenantId)
                    .single();
                
                if (tenantError) throw tenantError;
                
                // Update tenant info card
                document.getElementById('tenantInfoCard').style.display = 'block';
                document.getElementById('tenantName').textContent = tenant.name;
                document.getElementById('tenantDetails').textContent = 
                    `Monthly rent: ‚Ç±${parseFloat(tenant.monthly_rent || 0).toLocaleString('en-PH')} | Due day: ${tenant.rent_due_day || '15'}th`;
                
                // Load tenant's ledger entries
                let query = supabaseClient
                    .from('ledger_entries')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('tenant_id', tenantId)
                    .order('entry_date', { ascending: true }) // Chronological for running balance
                    .order('created_at', { ascending: true });
                
                if (dateFrom) {
                    query = query.gte('entry_date', dateFrom);
                }
                
                if (dateTo) {
                    query = query.lte('entry_date', dateTo);
                }
                
                const { data: ledgerEntries, error: ledgerError } = await query;
                
                if (ledgerError) throw ledgerError;
                
                currentTenantEntries = ledgerEntries || [];
                updateTenantLedgerTables(tenant, currentTenantEntries);
                updateTenantLedgerSubtitle(dateFrom, dateTo);
                
            } catch (error) {
                console.error('Error loading tenant ledger:', error);
                alert('Failed to load tenant ledger: ' + error.message);
            }
        }
        
        // Reset tenant filters
        function resetTenantFilters() {
            document.getElementById('tenantDateFrom').value = '';
            document.getElementById('tenantDateTo').value = '';
            loadTenantLedger();
        }
        
        // Update tenant ledger tables
        function updateTenantLedgerTables(tenant, entries) {
            // Update subtitle
            const subtitle = document.getElementById('tenantLedgerSubtitle');
            subtitle.textContent = entries.length > 0 ? 
                `${entries.length} transactions with running balance` : 
                'No transactions found';
            
            // Update current balance
            const lastEntry = entries[entries.length - 1];
            const currentBalance = lastEntry ? parseFloat(lastEntry.running_balance || 0) : 0;
            
            const balanceElement = document.getElementById('tenantCurrentBalance');
            balanceElement.textContent = 
                '‚Ç±' + Math.abs(currentBalance).toLocaleString('en-PH', { minimumFractionDigits: 2 });
            
            if (currentBalance > 0) {
                balanceElement.className = 'stat-number currency-negative';
                balanceElement.innerHTML = '‚Ç±' + Math.abs(currentBalance).toLocaleString('en-PH', { minimumFractionDigits: 2 }) + ' <span style="color: #991b1b; font-size: 0.75em;">(Due)</span>';
                document.getElementById('tenantBalanceStatus').textContent = 'Balance Due';
                document.getElementById('tenantBalanceStatus').className = 'stat-trend';
            } else if (currentBalance < 0) {
                balanceElement.className = 'stat-number currency-positive';
                balanceElement.innerHTML = '‚Ç±' + Math.abs(currentBalance).toLocaleString('en-PH', { minimumFractionDigits: 2 }) + ' <span style="color: #065f46; font-size: 0.75em;">(Credit)</span>';
                document.getElementById('tenantBalanceStatus').textContent = 'Credit Balance';
                document.getElementById('tenantBalanceStatus').className = 'stat-trend';
            } else {
                balanceElement.className = 'stat-number';
                balanceElement.textContent = '‚Ç±0.00';
                document.getElementById('tenantBalanceStatus').textContent = 'Paid in Full';
                document.getElementById('tenantBalanceStatus').className = 'stat-trend';
            }
            
            // Update desktop table
            const desktopTbody = document.getElementById('tenantLedgerTableBody');
            const mobileTbody = document.getElementById('mobileTenantLedgerBody');
            
            if (entries.length === 0) {
                desktopTbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem;">
                            üì≠ No transactions found for this period.
                        </td>
                    </tr>
                `;
                mobileTbody.innerHTML = `
                    <tr>
                        <td style="text-align: center; padding: 2rem;">
                            üì≠ No transactions found for this period.
                        </td>
                    </tr>
                `;
                return;
            }
            
            let desktopHtml = '';
            let mobileHtml = '';
            
            entries.forEach(entry => {
                const date = new Date(entry.entry_date);
                
                // Type styling
                let typeClass, typeText;
                if (entry.type === 'charge') {
                    typeClass = 'status-moved-out';
                    typeText = 'Charge';
                } else {
                    typeClass = 'status-active';
                    typeText = 'Payment';
                }
                
                // Category styling
                let categoryClass;
                if (entry.category === 'rent') categoryClass = 'status-active';
                else if (entry.category === 'electric') categoryClass = 'status-moved-out';
                else if (entry.category === 'water') categoryClass = 'status-left';
                else categoryClass = '';
                
                // Amounts
                const chargeAmount = entry.type === 'charge' ? 
                    `‚Ç±${parseFloat(entry.amount || 0).toLocaleString('en-PH', { minimumFractionDigits: 2 })}` : '-';
                const paymentAmount = entry.type === 'payment' ? 
                    `‚Ç±${parseFloat(entry.amount || 0).toLocaleString('en-PH', { minimumFractionDigits: 2 })}` : '-';
                
                const runningBalance = parseFloat(entry.running_balance || 0);
                
                // Desktop row
                desktopHtml += `
                    <tr onclick="showTransactionDetails('${entry.id}')" style="cursor: pointer;">
                        <td>${date.toLocaleDateString('en-PH')}</td>
                        <td>
                            <span class="status-pill ${typeClass}">
                                ${typeText}
                            </span>
                        </td>
                        <td>
                            <span class="status-pill ${categoryClass}">
                                ${entry.category ? entry.category.charAt(0).toUpperCase() + entry.category.slice(1) : 'Other'}
                            </span>
                        </td>
                        <td>${entry.description || ''}</td>
                        <td class="currency ${entry.type === 'charge' ? 'currency-negative' : ''}">
                            ${chargeAmount}
                        </td>
                        <td class="currency ${entry.type === 'payment' ? 'currency-positive' : ''}">
                            ${paymentAmount}
                        </td>
                        <td class="currency">
                            ‚Ç±${runningBalance.toLocaleString('en-PH', { minimumFractionDigits: 2 })}
                        </td>
                    </tr>
                `;
                
                // Mobile row
                mobileHtml += `
                    <tr onclick="showTransactionDetails('${entry.id}')" style="cursor: pointer;">
                        <td data-label="Transaction">
                            <div style="margin-bottom: 1rem;">
                                <strong>${date.toLocaleDateString('en-PH')}</strong>
                                <span class="status-pill ${typeClass}" style="margin-left: 0.5rem;">
                                    ${typeText}
                                </span>
                            </div>
                            <div style="display: grid; gap: 0.5rem;">
                                <div><strong>Category:</strong> ${entry.category ? entry.category.charAt(0).toUpperCase() + entry.category.slice(1) : 'Other'}</div>
                                <div><strong>Description:</strong> ${entry.description || ''}</div>
                                <div><strong>${entry.type === 'charge' ? 'Charge' : 'Payment'}:</strong> 
                                    <span class="${entry.type === 'charge' ? 'currency-negative' : 'currency-positive'}">
                                        ‚Ç±${parseFloat(entry.amount || 0).toLocaleString('en-PH', { minimumFractionDigits: 2 })}
                                    </span>
                                </div>
                                <div><strong>Balance:</strong> 
                                    <span class="currency">
                                        ‚Ç±${runningBalance.toLocaleString('en-PH', { minimumFractionDigits: 2 })}
                                    </span>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            desktopTbody.innerHTML = desktopHtml;
            mobileTbody.innerHTML = mobileHtml;
        }
        
        // Update tenant ledger subtitle
        function updateTenantLedgerSubtitle(dateFrom, dateTo) {
            const subtitle = document.getElementById('tenantLedgerSubtitle');
            let dateRange = '';
            
            if (dateFrom && dateTo) {
                dateRange = ` from ${new Date(dateFrom).toLocaleDateString('en-PH')} to ${new Date(dateTo).toLocaleDateString('en-PH')}`;
            } else if (dateFrom) {
                dateRange = ` from ${new Date(dateFrom).toLocaleDateString('en-PH')}`;
            } else if (dateTo) {
                dateRange = ` until ${new Date(dateTo).toLocaleDateString('en-PH')}`;
            }
            
            subtitle.textContent = `Tenant ledger${dateRange}`;
        }
        
        // ============================================
        // TRANSACTION DETAILS MODAL
        // ============================================
        async function showTransactionDetails(entryId) {
            try {
                const { data: entry, error } = await supabaseClient
                    .from('ledger_entries')
                    .select(`
                        *,
                        tenants(name)
                    `)
                    .eq('id', entryId)
                    .single();
                
                if (error) throw error;
                
                const date = new Date(entry.entry_date);
                
                // Update modal content
                document.getElementById('transactionTitle').textContent = 
                    `${entry.type === 'charge' ? 'Charge' : 'Payment'} - ${entry.category ? entry.category.charAt(0).toUpperCase() + entry.category.slice(1) : 'Other'}`;
                document.getElementById('transactionDate').textContent = 
                    `Date: ${date.toLocaleDateString('en-PH')}`;
                document.getElementById('transactionTenant').textContent = 
                    entry.tenants?.name || 'N/A';
                
                // Type badge
                const typeBadge = document.getElementById('transactionType');
                typeBadge.textContent = entry.type === 'charge' ? 'Charge' : 'Payment';
                typeBadge.className = `status-pill ${entry.type === 'charge' ? 'status-moved-out' : 'status-active'}`;
                
                // Category badge
                const categoryBadge = document.getElementById('transactionCategory');
                categoryBadge.textContent = entry.category ? entry.category.charAt(0).toUpperCase() + entry.category.slice(1) : 'Other';
                if (entry.category === 'rent') categoryBadge.className = 'status-pill status-active';
                else if (entry.category === 'electric') categoryBadge.className = 'status-pill status-moved-out';
                else if (entry.category === 'water') categoryBadge.className = 'status-pill status-left';
                else categoryBadge.className = 'status-pill';
                
                // Amount
                const amountElement = document.getElementById('transactionAmount');
                amountElement.textContent = 
                    `${entry.type === 'charge' ? '-' : '+'}‚Ç±${parseFloat(entry.amount || 0).toLocaleString('en-PH', { minimumFractionDigits: 2 })}`;
                amountElement.className = `currency ${entry.type === 'charge' ? 'currency-negative' : 'currency-positive'}`;
                
                document.getElementById('transactionDescription').textContent = entry.description || 'No description';
                document.getElementById('transactionBalance').textContent = 
                    `‚Ç±${entry.running_balance ? parseFloat(entry.running_balance).toLocaleString('en-PH', { minimumFractionDigits: 2 }) : '0.00'}`;
                
                // Show notes if available
                const notesSection = document.getElementById('transactionNotes');
                const notesContent = document.getElementById('transactionNotesContent');
                if (entry.notes) {
                    notesContent.textContent = entry.notes;
                    notesSection.style.display = 'block';
                } else {
                    notesSection.style.display = 'none';
                }
                
                document.getElementById('transactionModal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading transaction details:', error);
                alert('Failed to load transaction details');
            }
        }
        
        function closeTransactionModal() {
            document.getElementById('transactionModal').classList.add('hidden');
        }
        
        // ============================================
        // EXPORT FUNCTIONALITY (Fixed as requested)
        // ============================================
        
        function showExportOptions() {
            document.getElementById('exportModal').classList.remove('hidden');
            updateExportScopeDescription();
        }
        
        function closeExportModal() {
            document.getElementById('exportModal').classList.add('hidden');
        }
        
        function updateExportScopeDescription() {
            const scope = document.querySelector('input[name="exportScope"]:checked').value;
            const description = document.getElementById('exportScopeDescription');
            
            if (scope === 'current') {
                if (currentView === 'general') {
                    description.textContent = 'Export currently filtered general ledger data';
                } else {
                    const tenantSelect = document.getElementById('selectTenant');
                    const tenantName = tenantSelect.options[tenantSelect.selectedIndex]?.text || 'selected tenant';
                    description.textContent = `Export ledger for ${tenantName}`;
                }
            } else {
                description.textContent = 'Export all ledger data for all tenants';
            }
        }
        
        async function performExport() {
            const format = document.querySelector('input[name="exportFormat"]:checked').value;
            const scope = document.querySelector('input[name="exportScope"]:checked').value;
            
            // Disable export button
            const exportBtn = document.getElementById('exportBtn');
            exportBtn.disabled = true;
            exportBtn.textContent = 'Exporting...';
            
            try {
                let entriesToExport = [];
                let exportTitle = '';
                
                if (scope === 'current') {
                    // Export current view
                    if (currentView === 'general') {
                        entriesToExport = currentFilteredEntries;
                        exportTitle = 'General Ledger';
                    } else {
                        entriesToExport = currentTenantEntries;
                        const tenantSelect = document.getElementById('selectTenant');
                        const tenantName = tenantSelect.options[tenantSelect.selectedIndex]?.text || 'Tenant';
                        exportTitle = `Ledger - ${tenantName}`;
                    }
                } else {
                    // Export all data
                    const { data: allEntries, error } = await supabaseClient
                        .from('ledger_entries')
                        .select(`
                            *,
                            tenants(name)
                        `)
                        .eq('user_id', currentUser.id)
                        .order('entry_date', { ascending: true });
                    
                    if (error) throw error;
                    
                    entriesToExport = allEntries || [];
                    exportTitle = 'Complete Ledger';
                }
                
                // Sort entries chronologically for export
                entriesToExport.sort((a, b) => new Date(a.entry_date) - new Date(b.entry_date));
                
                if (entriesToExport.length === 0) {
                    alert('‚ö†Ô∏è No data to export.');
                    exportBtn.disabled = false;
                    exportBtn.textContent = 'Export';
                    return;
                }
                
                if (format === 'csv') {
                    exportToCSV(entriesToExport, exportTitle);
                } else {
                    exportToPDF(entriesToExport, exportTitle);
                }
                
                closeExportModal();
                
            } catch (error) {
                console.error('Error exporting:', error);
                alert('‚ùå Failed to export: ' + error.message);
            } finally {
                exportBtn.disabled = false;
                exportBtn.textContent = 'Export';
            }
        }
        
        function exportToCSV(entries, title) {
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // CSV Header
            if (currentView === 'general') {
                csvContent += "Date,Tenant,Type,Category,Description,Amount,Balance\n";
            } else {
                csvContent += "Date,Type,Category,Description,Charge,Payment,Balance\n";
            }
            
            // Add rows
            entries.forEach(entry => {
                const date = new Date(entry.entry_date);
                const formattedDate = date.toLocaleDateString('en-PH');
                
                if (currentView === 'general') {
                    const row = [
                        formattedDate,
                        `"${entry.tenants?.name || 'N/A'}"`,
                        entry.type === 'charge' ? 'Charge' : 'Payment',
                        entry.category || 'other',
                        `"${entry.description || ''}"`,
                        `${entry.type === 'charge' ? '-' : ''}${parseFloat(entry.amount || 0).toFixed(2)}`,
                        parseFloat(entry.running_balance || 0).toFixed(2)
                    ];
                    csvContent += row.join(",") + "\n";
                } else {
                    const chargeAmount = entry.type === 'charge' ? parseFloat(entry.amount || 0).toFixed(2) : '';
                    const paymentAmount = entry.type === 'payment' ? parseFloat(entry.amount || 0).toFixed(2) : '';
                    
                    const row = [
                        formattedDate,
                        entry.type === 'charge' ? 'Charge' : 'Payment',
                        entry.category || 'other',
                        `"${entry.description || ''}"`,
                        chargeAmount,
                        paymentAmount,
                        parseFloat(entry.running_balance || 0).toFixed(2)
                    ];
                    csvContent += row.join(",") + "\n";
                }
            });
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`‚úÖ CSV exported successfully!\n${entries.length} records downloaded.`);
        }
        
        function exportToPDF(entries, title) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add title
                doc.setFontSize(16);
                doc.text(title, 14, 22);
                
                // Add subtitle
                doc.setFontSize(10);
                doc.text(`Exported on: ${new Date().toLocaleDateString('en-PH')}`, 14, 30);
                doc.text(`Total Records: ${entries.length}`, 14, 35);
                
                // Prepare table data
                const tableData = [];
                
                if (currentView === 'general') {
                    // General ledger table
                    entries.forEach(entry => {
                        const date = new Date(entry.entry_date);
                        const row = [
                            date.toLocaleDateString('en-PH'),
                            entry.tenants?.name || 'N/A',
                            entry.type === 'charge' ? 'Charge' : 'Payment',
                            entry.category || 'other',
                            entry.description || '',
                            `${entry.type === 'charge' ? '-' : '+'}‚Ç±${parseFloat(entry.amount || 0).toFixed(2)}`,
                            `‚Ç±${parseFloat(entry.running_balance || 0).toFixed(2)}`
                        ];
                        tableData.push(row);
                    });
                    
                    // Create table
                    doc.autoTable({
                        head: [['Date', 'Tenant', 'Type', 'Category', 'Description', 'Amount', 'Balance']],
                        body: tableData,
                        startY: 40,
                        theme: 'grid',
                        headStyles: { fillColor: [59, 130, 246] },
                        columnStyles: {
                            0: { cellWidth: 25 },
                            1: { cellWidth: 30 },
                            2: { cellWidth: 20 },
                            3: { cellWidth: 25 },
                            4: { cellWidth: 40 },
                            5: { cellWidth: 25 },
                            6: { cellWidth: 25 }
                        }
                    });
                } else {
                    // Tenant ledger table
                    entries.forEach(entry => {
                        const date = new Date(entry.entry_date);
                        const chargeAmount = entry.type === 'charge' ? `‚Ç±${parseFloat(entry.amount || 0).toFixed(2)}` : '';
                        const paymentAmount = entry.type === 'payment' ? `‚Ç±${parseFloat(entry.amount || 0).toFixed(2)}` : '';
                        
                        const row = [
                            date.toLocaleDateString('en-PH'),
                            entry.type === 'charge' ? 'Charge' : 'Payment',
                            entry.category || 'other',
                            entry.description || '',
                            chargeAmount,
                            paymentAmount,
                            `‚Ç±${parseFloat(entry.running_balance || 0).toFixed(2)}`
                        ];
                        tableData.push(row);
                    });
                    
                    // Create table
                    doc.autoTable({
                        head: [['Date', 'Type', 'Category', 'Description', 'Charge', 'Payment', 'Balance']],
                        body: tableData,
                        startY: 40,
                        theme: 'grid',
                        headStyles: { fillColor: [59, 130, 246] },
                        columnStyles: {
                            0: { cellWidth: 25 },
                            1: { cellWidth: 20 },
                            2: { cellWidth: 25 },
                            3: { cellWidth: 40 },
                            4: { cellWidth: 25 },
                            5: { cellWidth: 25 },
                            6: { cellWidth: 25 }
                        }
                    });
                }
                
                // Add summary
                const finalY = doc.lastAutoTable.finalY + 10;
                
                let totalCharges = 0;
                let totalPayments = 0;
                
                entries.forEach(entry => {
                    const amount = parseFloat(entry.amount || 0);
                    if (entry.type === 'charge') {
                        totalCharges += amount;
                    } else {
                        totalPayments += amount;
                    }
                });
                
                const netBalance = totalCharges - totalPayments;
                
                doc.setFontSize(12);
                doc.text('Summary', 14, finalY);
                
                doc.setFontSize(10);
                doc.text(`Total Charges: ‚Ç±${totalCharges.toFixed(2)}`, 14, finalY + 8);
                doc.text(`Total Payments: ‚Ç±${totalPayments.toFixed(2)}`, 14, finalY + 16);
                
                const balanceColor = netBalance > 0 ? [220, 38, 38] : netBalance < 0 ? [5, 150, 105] : [0, 0, 0];
                doc.setTextColor(...balanceColor);
                doc.text(`Net Balance: ‚Ç±${Math.abs(netBalance).toFixed(2)} ${netBalance > 0 ? '(Due)' : netBalance < 0 ? '(Credit)' : ''}`, 14, finalY + 24);
                doc.setTextColor(0, 0, 0);
                
                // Save PDF
                doc.save(`${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
                
                alert(`‚úÖ PDF exported successfully!\n${entries.length} records downloaded.`);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('‚ùå Failed to generate PDF. Please try CSV export instead.');
            }
        }
        
        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }
        
        async function logout() {
            await supabaseClient.auth.signOut();
            window.location.href = 'login.html';
        }
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const mobileBtn = document.querySelector('.mobile-menu-btn');
            
            if (window.innerWidth <= 1024 && 
                !sidebar.contains(event.target) && 
                event.target !== mobileBtn) {
                sidebar.classList.remove('active');
            }
        });
    </script>
    
    <style>
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-overlay.hidden {
            display: none;
        }
        
        .modal {
            background: white;
            border-radius: 0.5rem;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }
        
        .close-modal:hover {
            color: #374151;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        
        .form-group select,
        .form-group input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 1rem;
        }
        
        .small-text {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid #d1d5db;
            color: #374151;
        }
        
        .btn-outline:hover {
            background: #f3f4f6;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .currency {
            font-family: monospace;
            font-weight: 600;
        }
        
        .currency-positive {
            color: #065f46;
        }
        
        .currency-negative {
            color: #991b1b;
        }
        
        .status-pill {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-active {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-moved-out {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-left {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .table-container {
            background: white;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .table-header h2 {
            margin: 0;
            font-size: 1.25rem;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table thead {
            background: #f9fafb;
        }
        
        .data-table th {
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .data-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .data-table tbody tr:hover {
            background: #f9fafb;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .stat-card h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
            font-weight: 600;
            color: #6b7280;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .stat-trend {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 1024px) {
            .mobile-stacked .data-table td[data-label] {
                display: grid;
                grid-template-columns: 1fr;
                gap: 0.5rem;
                padding: 1rem;
            }
            
            .mobile-stacked .data-table td[data-label]::before {
                content: attr(data-label);
                font-weight: 600;
                color: #374151;
            }
        }
    </style>
</body>
</html>            </button>
            <button id="viewTenant" class="btn btn-outline" onclick="switchView('tenant')">
                Tenant Ledger
            </button>
        </div>
        
        <!-- ============================================
             GENERAL LEDGER VIEW
             ============================================ -->
        <div id="generalLedgerView">
            <!-- Filter Options -->
            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                <select id="filterType" onchange="filterGeneralLedger()" class="form-group" style="flex: 1; min-width: 150px;">
                    <option value="">All Types</option>
                    <option value="charge">Charges</option>
                    <option value="payment">Payments</option>
                </select>
                <select id="filterCategory" onchange="filterGeneralLedger()" class="form-group" style="flex: 1; min-width: 150px;">
                    <option value="">All Categories</option>
                    <option value="rent">Rent</option>
                    <option value="electric">Electric</option>
                    <option value="water">Water</option>
                    <option value="wifi">Wi-Fi</option>
                    <option value="other">Other</option>
                </select>
                <input type="date" id="filterDateFrom" onchange="filterGeneralLedger()" class="form-group" style="flex: 1; min-width: 150px;" placeholder="From Date">
                <input type="date" id="filterDateTo" onchange="filterGeneralLedger()" class="form-group" style="flex: 1; min-width: 150px;" placeholder="To Date">
                <button onclick="resetGeneralFilters()" class="btn btn-outline" style="height: fit-content; align-self: flex-end;">
                    Reset
                </button>
            </div>
            
            <!-- General Ledger Table -->
            <div class="table-container">
                <div class="table-header">
                    <h2>üìã General Ledger</h2>
                    <span class="small-text">All transactions chronological</span>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Tenant</th>
                            <th>Type</th>
                            <th>Category</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody id="generalLedgerTableBody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem;">
                                Loading general ledger...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Summary Stats -->
            <div class="stats-grid" style="margin-top: 2rem;">
                <div class="stat-card">
                    <h3>Total Charges</h3>
                    <div class="stat-number currency-negative" id="totalCharges">‚Ç±0.00</div>
                    <span class="stat-trend">Rent + Utilities</span>
                </div>
                <div class="stat-card">
                    <h3>Total Payments</h3>
                    <div class="stat-number currency-positive" id="totalPayments">‚Ç±0.00</div>
                    <span class="stat-trend">Received</span>
                </div>
                <div class="stat-card">
                    <h3>Net Balance</h3>
                    <div class="stat-number" id="netBalance">‚Ç±0.00</div>
                    <span class="stat-trend">Current</span>
                </div>
            </div>
        </div>
        
        <!-- ============================================
             TENANT LEDGER VIEW
             ============================================ -->
        <div id="tenantLedgerView" style="display: none;">
            <!-- Tenant Selection -->
            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; align-items: flex-end; flex-wrap: wrap;">
                <div class="form-group" style="flex: 1; min-width: 300px;">
                    <label for="selectTenant">Select Tenant</label>
                    <select id="selectTenant" onchange="loadTenantLedger()" style="width: 100%;">
                        <option value="">Select a tenant...</option>
                    </select>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="date" id="tenantDateFrom" onchange="loadTenantLedger()" class="form-group" style="flex: 1; min-width: 150px;" placeholder="From Date">
                    <input type="date" id="tenantDateTo" onchange="loadTenantLedger()" class="form-group" style="flex: 1; min-width: 150px;" placeholder="To Date">
                    <button onclick="resetTenantFilters()" class="btn btn-outline" style="height: fit-content;">
                        Reset
                    </button>
                </div>
            </div>
            
            <!-- Tenant Info Card -->
            <div id="tenantInfoCard" style="display: none; margin-bottom: 1.5rem;">
                <div class="stat-card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 id="tenantName">Loading...</h3>
                            <p class="small-text" id="tenantDetails">Monthly rent: ‚Ç±0.00 | Due day: 0th</p>
                        </div>
                        <div style="text-align: right;">
                            <div class="stat-number" id="tenantCurrentBalance">‚Ç±0.00</div>
                            <span class="stat-trend" id="tenantBalanceStatus">Current balance</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tenant Ledger Table -->
            <div class="table-container">
                <div class="table-header">
                    <h2>üë§ Tenant Ledger</h2>
                    <span class="small-text" id="tenantLedgerSubtitle">Filtered by tenant with running balance</span>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Category</th>
                            <th>Description</th>
                            <th>Charge</th>
                            <th>Payment</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody id="tenantLedgerTableBody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem;">
                                Select a tenant to view their ledger.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Mobile-friendly ledger view -->
            <div class="table-container mobile-stacked hidden" style="margin-top: 1rem;">
                <table class="data-table">
                    <tbody id="mobileTenantLedgerBody">
                        <!-- Will be populated for mobile -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- ============================================
         MODAL: TRANSACTION DETAILS
         ============================================ -->
    <div class="modal-overlay hidden" id="transactionModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Transaction Details</h3>
                <button class="close-modal" onclick="closeTransactionModal()">√ó</button>
            </div>
            
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <h4 id="transactionTitle">Loading...</h4>
                    <p class="small-text" id="transactionDate">Date: Loading...</p>
                </div>
                
                <div style="display: grid; gap: 1rem;">
                    <div>
                        <strong>Tenant:</strong>
                        <p id="transactionTenant">Loading...</p>
                    </div>
                    <div>
                        <strong>Type:</strong>
                        <span id="transactionType" class="status-pill">Loading</span>
                    </div>
                    <div>
                        <strong>Category:</strong>
                        <span id="transactionCategory" class="status-pill">Loading</span>
                    </div>
                    <div>
                        <strong>Amount:</strong>
                        <p id="transactionAmount" class="currency">Loading...</p>
                    </div>
                    <div>
                        <strong>Description:</strong>
                        <p id="transactionDescription">Loading...</p>
                    </div>
                    <div>
                        <strong>Running Balance:</strong>
                        <p id="transactionBalance" class="currency">Loading...</p>
                    </div>
                    <div id="transactionNotes" style="display: none;">
                        <strong>Notes:</strong>
                        <p id="transactionNotesContent">Loading...</p>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeTransactionModal()">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://hnjlrjtiomdqcqznkuxh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhuamxyanRpb21kcWNxem5rdXhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4NDQ5MTUsImV4cCI6MjA4NTQyMDkxNX0.iW9E91LYLNSkpjiITNcXa7Zj1rpcw8euriHkgfQ19dQ';
        const supabase = supabaseClient.createClient(supabaseUrl, supabaseKey);
        
        let currentUser = null;
        let allLedgerEntries = [];
        let allTenants = [];
        let currentView = 'general';
        let selectedTenantId = null;
        
        // Check authentication
        supabase.auth.getSession().then(async ({ data: { session } }) => {
            if (!session) {
                window.location.href = 'login.html';
            } else {
                currentUser = session.user;
                await loadTenants();
                await loadGeneralLedger();
                
                // Check if tenant ID is stored from dashboard
                const storedTenantId = localStorage.getItem('selectedTenantId');
                if (storedTenantId) {
                    localStorage.removeItem('selectedTenantId');
                    switchView('tenant');
                    document.getElementById('selectTenant').value = storedTenantId;
                    loadTenantLedger();
                }
                
                // Setup mobile/desktop view
                setupResponsiveLedger();
                window.addEventListener('resize', setupResponsiveLedger);
            }
        });
        
        // Setup responsive ledger tables
        function setupResponsiveLedger() {
            const desktopTable = document.querySelector('#tenantLedgerView .table-container');
            const mobileTable = document.querySelector('#tenantLedgerView .mobile-stacked');
            
            if (window.innerWidth <= 1024) {
                // Mobile view
                desktopTable.classList.add('hidden');
                mobileTable.classList.remove('hidden');
            } else {
                // Desktop view
                desktopTable.classList.remove('hidden');
                mobileTable.classList.add('hidden');
            }
        }
        
        // Load tenants for dropdown
        async function loadTenants() {
            try {
                const { data: tenants, error } = await supabase
                    .from('tenants')
                    .select('id, name, monthly_rent, rent_due_day, status')
                    .eq('user_id', currentUser.id)
                    .order('name');
                
                if (error) throw error;
                
                allTenants = tenants || [];
                
                // Update tenant dropdown
                const select = document.getElementById('selectTenant');
                select.innerHTML = '<option value="">Select a tenant...</option>';
                
                tenants.forEach(tenant => {
                    const status = tenant.status === 'active' ? 'Active' : 
                                  tenant.status === 'moved_out' ? 'Moved Out' : 'Left';
                    
                    select.innerHTML += `
                        <option value="${tenant.id}">
                            ${tenant.name} (${status}) - ‚Ç±${parseFloat(tenant.monthly_rent).toLocaleString('en-PH')}
                        </option>
                    `;
                });
                
            } catch (error) {
                console.error('Error loading tenants:', error);
            }
        }
        
        // Load general ledger entries
        async function loadGeneralLedger() {
            try {
                const { data: ledgerEntries, error } = await supabase
                    .from('ledger_entries')
                    .select(`
                        *,
                        tenants(name)
                    `)
                    .eq('user_id', currentUser.id)
                    .order('entry_date', { ascending: false })
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                allLedgerEntries = ledgerEntries || [];
                filterGeneralLedger();
                
            } catch (error) {
                console.error('Error loading ledger entries:', error);
            }
        }
        
        // ============================================
        // GENERAL LEDGER FUNCTIONS
        // ============================================
        
        // Switch between general and tenant views
        function switchView(view) {
            currentView = view;
            
            const generalView = document.getElementById('generalLedgerView');
            const tenantView = document.getElementById('tenantLedgerView');
            const generalBtn = document.getElementById('viewGeneral');
            const tenantBtn = document.getElementById('viewTenant');
            
            if (view === 'general') {
                generalView.style.display = 'block';
                tenantView.style.display = 'none';
                generalBtn.className = 'btn btn-primary';
                tenantBtn.className = 'btn btn-outline';
            } else {
                generalView.style.display = 'none';
                tenantView.style.display = 'block';
                generalBtn.className = 'btn btn-outline';
                tenantBtn.className = 'btn btn-primary';
            }
        }
        
        // Filter general ledger
        function filterGeneralLedger() {
            const type = document.getElementById('filterType').value;
            const category = document.getElementById('filterCategory').value;
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;
            
            let filtered = allLedgerEntries;
            
            if (type) {
                filtered = filtered.filter(entry => entry.type === type);
            }
            
            if (category) {
                filtered = filtered.filter(entry => entry.category === category);
            }
            
            if (dateFrom) {
                filtered = filtered.filter(entry => entry.entry_date >= dateFrom);
            }
            
            if (dateTo) {
                filtered = filtered.filter(entry => entry.entry_date <= dateTo);
            }
            
            updateGeneralLedgerTable(filtered);
            updateGeneralSummary(filtered);
        }
        
        // Reset general filters
        function resetGeneralFilters() {
            document.getElementById('filterType').value = '';
            document.getElementById('filterCategory').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            filterGeneralLedger();
        }
        
        // Update general ledger table
        function updateGeneralLedgerTable(entries) {
            const tbody = document.getElementById('generalLedgerTableBody');
            
            if (entries.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem;">
                            No ledger entries found.
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort by date (chronological)
            entries.sort((a, b) => new Date(a.entry_date) - new Date(b.entry_date));
            
            let html = '';
            entries.forEach(entry => {
                const date = new Date(entry.entry_date);
                
                // Type styling
                let typeClass, typeText;
                if (entry.type === 'charge') {
                    typeClass = 'status-moved-out';
                    typeText = 'Charge';
                } else {
                    typeClass = 'status-active';
                    typeText = 'Payment';
                }
                
                // Category styling
                let categoryClass;
                if (entry.category === 'rent') categoryClass = 'status-active';
                else if (entry.category === 'electric') categoryClass = 'status-moved-out';
                else if (entry.category === 'water') categoryClass = 'status-left';
                else categoryClass = '';
                
                // Amount styling
                const amountClass = entry.type === 'charge' ? 'currency-negative' : 'currency-positive';
                const amountSign = entry.type === 'charge' ? '-' : '+';
                
                html += `
                    <tr onclick="showTransactionDetails('${entry.id}')" style="cursor: pointer;">
                        <td>${date.toLocaleDateString('en-PH')}</td>
                        <td>${entry.tenants?.name || 'N/A'}</td>
                        <td>
                            <span class="status-pill ${typeClass}">
                                ${typeText}
                            </span>
                        </td>
                        <td>
                            <span class="status-pill ${categoryClass}">
                                ${entry.category.charAt(0).toUpperCase() + entry.category.slice(1)}
                            </span>
                        </td>
                        <td>${entry.description || ''}</td>
                        <td class="currency ${amountClass}">
                            ${amountSign}‚Ç±${parseFloat(entry.amount).toLocaleString('en-PH', { minimumFractionDigits: 2 })}
                        </td>
                        <td class="currency">
                            ‚Ç±${entry.running_balance ? parseFloat(entry.running_balance).toLocaleString('en-PH', { minimumFractionDigits: 2 }) : '0.00'}
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Update general ledger summary
        function updateGeneralSummary(entries = allLedgerEntries) {
            let totalCharges = 0;
            let totalPayments = 0;
            
            entries.forEach(entry => {
                const amount = parseFloat(entry.amount);
                if (entry.type === 'charge') {
                    totalCharges += amount;
                } else {
                    totalPayments += amount;
                }
            });
            
            const netBalance = totalCharges - totalPayments;
            
            document.getElementById('totalCharges').textContent = 
                '‚Ç±' + totalCharges.toLocaleString('en-PH', { minimumFractionDigits: 2 });
            document.getElementById('totalPayments').textContent = 
                '‚Ç±' + totalPayments.toLocaleString('en-PH', { minimumFractionDigits: 2 });
            
            const netBalanceElement = document.getElementById('netBalance');
            netBalanceElement.textContent = 
                '‚Ç±' + Math.abs(netBalance).toLocaleString('en-PH', { minimumFractionDigits: 2 });
            
            if (netBalance > 0) {
                netBalanceElement.className = 'stat-number currency-negative';
            } else if (netBalance < 0) {
                netBalanceElement.className = 'stat-number currency-positive';
            } else {
                netBalanceElement.className = 'stat-number';
            }
        }
        
        // ============================================
        // TENANT LEDGER FUNCTIONS
        // ============================================
        
        // Load tenant ledger
        async function loadTenantLedger() {
            const tenantId = document.getElementById('selectTenant').value;
            const dateFrom = document.getElementById('tenantDateFrom').value;
            const dateTo = document.getElementById('tenantDateTo').value;
            
            if (!tenantId) {
                document.getElementById('tenantInfoCard').style.display = 'none';
                document.getElementById('tenantLedgerTableBody').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem;">
                            Select a tenant to view their ledger.
                        </td>
                    </tr>
                `;
                document.getElementById('mobileTenantLedgerBody').innerHTML = `
                    <tr>
                        <td style="text-align: center; padding: 2rem;">
                            Select a tenant to view their ledger.
                        </td>
                    </tr>
                `;
                return;
            }
            
            selectedTenantId = tenantId;
            
            try {
                // Load tenant info
                const { data: tenant, error: tenantError } = await supabase
                    .from('tenants')
                    .select('*')
                    .eq('id', tenantId)
                    .single();
                
                if (tenantError) throw tenantError;
                
                // Update tenant info card
                document.getElementById('tenantInfoCard').style.display = 'block';
                document.getElementById('tenantName').textContent = tenant.name;
                document.getElementById('tenantDetails').textContent = 
                    `Monthly rent: ‚Ç±${parseFloat(tenant.monthly_rent).toLocaleString('en-PH')} | Due day: ${tenant.rent_due_day}th`;
                
                // Load tenant's ledger entries
                let query = supabase
                    .from('ledger_entries')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('tenant_id', tenantId)
                    .order('entry_date', { ascending: true }) // Chronological for running balance
                    .order('created_at', { ascending: true });
                
                if (dateFrom) {
                    query = query.gte('entry_date', dateFrom);
                }
                
                if (dateTo) {
                    query = query.lte('entry_date', dateTo);
                }
                
                const { data: ledgerEntries, error: ledgerError } = await query;
                
                if (ledgerError) throw ledgerError;
                
                updateTenantLedgerTables(tenant, ledgerEntries || []);
                updateTenantLedgerSubtitle(dateFrom, dateTo);
                
            } catch (error) {
                console.error('Error loading tenant ledger:', error);
                alert('Failed to load tenant ledger');
            }
        }
        
        // Reset tenant filters
        function resetTenantFilters() {
            document.getElementById('tenantDateFrom').value = '';
            document.getElementById('tenantDateTo').value = '';
            loadTenantLedger();
        }
        
        // Update tenant ledger tables
        function updateTenantLedgerTables(tenant, entries) {
            // Update subtitle
            const subtitle = document.getElementById('tenantLedgerSubtitle');
            subtitle.textContent = entries.length > 0 ? 
                `${entries.length} transactions with running balance` : 
                'No transactions found';
            
            // Update current balance
            const lastEntry = entries[entries.length - 1];
            const currentBalance = lastEntry ? parseFloat(lastEntry.running_balance) : 0;
            
            const balanceElement = document.getElementById('tenantCurrentBalance');
            balanceElement.textContent = 
                '‚Ç±' + Math.abs(currentBalance).toLocaleString('en-PH', { minimumFractionDigits: 2 });
            
            if (currentBalance > 0) {
                balanceElement.className = 'stat-number currency-negative';
                document.getElementById('tenantBalanceStatus').textContent = 'Balance Due';
                document.getElementById('tenantBalanceStatus').className = 'stat-trend';
            } else if (currentBalance < 0) {
                balanceElement.className = 'stat-number currency-positive';
                document.getElementById('tenantBalanceStatus').textContent = 'Credit Balance';
                document.getElementById('tenantBalanceStatus').className = 'stat-trend';
            } else {
                balanceElement.className = 'stat-number';
                document.getElementById('tenantBalanceStatus').textContent = 'Paid in Full';
                document.getElementById('tenantBalanceStatus').className = 'stat-trend';
            }
            
            // Update desktop table
            const desktopTbody = document.getElementById('tenantLedgerTableBody');
            const mobileTbody = document.getElementById('mobileTenantLedgerBody');
            
            if (entries.length === 0) {
                desktopTbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem;">
                            No transactions found for this period.
                        </td>
                    </tr>
                `;
                mobileTbody.innerHTML = `
                    <tr>
                        <td style="text-align: center; padding: 2rem;">
                            No transactions found for this period.
                        </td>
                    </tr>
                `;
                return;
            }
            
            let desktopHtml = '';
            let mobileHtml = '';
            let runningBalance = 0;
            
            entries.forEach(entry => {
                const date = new Date(entry.entry_date);
                
                // Type styling
                let typeClass, typeText;
                if (entry.type === 'charge') {
                    typeClass = 'status-moved-out';
                    typeText = 'Charge';
                } else {
                    typeClass = 'status-active';
                    typeText = 'Payment';
                }
                
                // Category styling
                let categoryClass;
                if (entry.category === 'rent') categoryClass = 'status-active';
                else if (entry.category === 'electric') categoryClass = 'status-moved-out';
                else if (entry.category === 'water') categoryClass = 'status-left';
                else categoryClass = '';
                
                // Amounts
                const chargeAmount = entry.type === 'charge' ? 
                    `‚Ç±${parseFloat(entry.amount).toLocaleString('en-PH', { minimumFractionDigits: 2 })}` : '-';
                const paymentAmount = entry.type === 'payment' ? 
                    `‚Ç±${parseFloat(entry.amount).toLocaleString('en-PH', { minimumFractionDigits: 2 })}` : '-';
                
                runningBalance = parseFloat(entry.running_balance);
                
                // Desktop row
                desktopHtml += `
                    <tr onclick="showTransactionDetails('${entry.id}')" style="cursor: pointer;">
                        <td>${date.toLocaleDateString('en-PH')}</td>
                        <td>
                            <span class="status-pill ${typeClass}">
                                ${typeText}
                            </span>
                        </td>
                        <td>
                            <span class="status-pill ${categoryClass}">
                                ${entry.category.charAt(0).toUpperCase() + entry.category.slice(1)}
                            </span>
                        </td>
                        <td>${entry.description || ''}</td>
                        <td class="currency ${entry.type === 'charge' ? 'currency-negative' : ''}">
                            ${chargeAmount}
                        </td>
                        <td class="currency ${entry.type === 'payment' ? 'currency-positive' : ''}">
                            ${paymentAmount}
                        </td>
                        <td class="currency">
                            ‚Ç±${runningBalance.toLocaleString('en-PH', { minimumFractionDigits: 2 })}
                        </td>
                    </tr>
                `;
                
                // Mobile row
                mobileHtml += `
                    <tr onclick="showTransactionDetails('${entry.id}')" style="cursor: pointer;">
                        <td data-label="Transaction">
                            <div style="margin-bottom: 1rem;">
                                <strong>${date.toLocaleDateString('en-PH')}</strong>
                                <span class="status-pill ${typeClass}" style="margin-left: 0.5rem;">
                                    ${typeText}
                                </span>
                            </div>
                            <div style="display: grid; gap: 0.5rem;">
                                <div><strong>Category:</strong> ${entry.category.charAt(0).toUpperCase() + entry.category.slice(1)}</div>
                                <div><strong>Description:</strong> ${entry.description || ''}</div>
                                <div><strong>${entry.type === 'charge' ? 'Charge' : 'Payment'}:</strong> 
                                    <span class="${entry.type === 'charge' ? 'currency-negative' : 'currency-positive'}">
                                        ‚Ç±${parseFloat(entry.amount).toLocaleString('en-PH', { minimumFractionDigits: 2 })}
                                    </span>
                                </div>
                                <div><strong>Balance:</strong> 
                                    <span class="currency">
                                        ‚Ç±${runningBalance.toLocaleString('en-PH', { minimumFractionDigits: 2 })}
                                    </span>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            desktopTbody.innerHTML = desktopHtml;
            mobileTbody.innerHTML = mobileHtml;
        }
        
        // Update tenant ledger subtitle
        function updateTenantLedgerSubtitle(dateFrom, dateTo) {
            const subtitle = document.getElementById('tenantLedgerSubtitle');
            let dateRange = '';
            
            if (dateFrom && dateTo) {
                dateRange = ` from ${new Date(dateFrom).toLocaleDateString('en-PH')} to ${new Date(dateTo).toLocaleDateString('en-PH')}`;
            } else if (dateFrom) {
                dateRange = ` from ${new Date(dateFrom).toLocaleDateString('en-PH')}`;
            } else if (dateTo) {
                dateRange = ` until ${new Date(dateTo).toLocaleDateString('en-PH')}`;
            }
            
            subtitle.textContent = `Tenant ledger${dateRange}`;
        }
        
        // ============================================
        // TRANSACTION DETAILS MODAL
        // ============================================
        async function showTransactionDetails(entryId) {
            try {
                const { data: entry, error } = await supabase
                    .from('ledger_entries')
                    .select(`
                        *,
                        tenants(name)
                    `)
                    .eq('id', entryId)
                    .single();
                
                if (error) throw error;
                
                const date = new Date(entry.entry_date);
                
                // Update modal content
                document.getElementById('transactionTitle').textContent = 
                    `${entry.type === 'charge' ? 'Charge' : 'Payment'} - ${entry.category.charAt(0).toUpperCase() + entry.category.slice(1)}`;
                document.getElementById('transactionDate').textContent = 
                    `Date: ${date.toLocaleDateString('en-PH')}`;
                document.getElementById('transactionTenant').textContent = 
                    entry.tenants?.name || 'N/A';
                
                // Type badge
                const typeBadge = document.getElementById('transactionType');
                typeBadge.textContent = entry.type === 'charge' ? 'Charge' : 'Payment';
                typeBadge.className = `status-pill ${entry.type === 'charge' ? 'status-moved-out' : 'status-active'}`;
                
                // Category badge
                const categoryBadge = document.getElementById('transactionCategory');
                categoryBadge.textContent = entry.category.charAt(0).toUpperCase() + entry.category.slice(1);
                if (entry.category === 'rent') categoryBadge.className = 'status-pill status-active';
                else if (entry.category === 'electric') categoryBadge.className = 'status-pill status-moved-out';
                else if (entry.category === 'water') categoryBadge.className = 'status-pill status-left';
                else categoryBadge.className = 'status-pill';
                
                // Amount
                const amountElement = document.getElementById('transactionAmount');
                amountElement.textContent = 
                    `${entry.type === 'charge' ? '-' : '+'}‚Ç±${parseFloat(entry.amount).toLocaleString('en-PH', { minimumFractionDigits: 2 })}`;
                amountElement.className = `currency ${entry.type === 'charge' ? 'currency-negative' : 'currency-positive'}`;
                
                document.getElementById('transactionDescription').textContent = entry.description || 'No description';
                document.getElementById('transactionBalance').textContent = 
                    `‚Ç±${entry.running_balance ? parseFloat(entry.running_balance).toLocaleString('en-PH', { minimumFractionDigits: 2 }) : '0.00'}`;
                
                // Show notes if available
                const notesSection = document.getElementById('transactionNotes');
                const notesContent = document.getElementById('transactionNotesContent');
                if (entry.notes) {
                    notesContent.textContent = entry.notes;
                    notesSection.style.display = 'block';
                } else {
                    notesSection.style.display = 'none';
                }
                
                document.getElementById('transactionModal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading transaction details:', error);
                alert('Failed to load transaction details');
            }
        }
        
        // ============================================
        // EXPORT & PRINT FUNCTIONS
        // ============================================
        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            
            if (currentView === 'general') {
                // Export general ledger
                csvContent += "Date,Tenant,Type,Category,Description,Amount,Balance\n";
                
                const entries = allLedgerEntries.sort((a, b) => new Date(a.entry_date) - new Date(b.entry_date));
                entries.forEach(entry => {
                    const date = new Date(entry.entry_date);
                    const row = [
                        date.toLocaleDateString('en-PH'),
                        entry.tenants?.name || 'N/A',
                        entry.type === 'charge' ? 'Charge' : 'Payment',
                        entry.category,
                        `"${entry.description || ''}"`,
                        `${entry.type === 'charge' ? '-' : ''}${parseFloat(entry.amount).toFixed(2)}`,
                        parseFloat(entry.running_balance || 0).toFixed(2)
                    ];
                    csvContent += row.join(",") + "\n";
                });
            } else {
                // Export tenant
